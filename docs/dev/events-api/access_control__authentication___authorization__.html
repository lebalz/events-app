<!doctype html><html lang=de-CH dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/events-api/access_control__authentication___authorization__" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.0"><title data-rh=true>Chapter 4: Access Control (Authentication & Authorization) | Events</title><meta data-rh=true property=og:image content=https://events.gbsl.website/img/og-preview.jpeg><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://events.gbsl.website/docs/dev/events-api/access_control__authentication___authorization__><meta data-rh=true property=og:locale content=de_CH><meta data-rh=true property=og:locale:alternate content=fr_CH><meta data-rh=true name=docusaurus_locale content=de><meta data-rh=true name=docsearch:language content=de><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Chapter 4: Access Control (Authentication & Authorization) | Events"><meta data-rh=true name=description content="Welcome back! In the previous chapter, API Web Server (Express.js), we learned how our events-api uses Express.js as its front door to receive requests from the outside world (like users or other applications). Express listens for requests, routes them to the right place, and uses middleware for initial processing like logging or parsing data."><meta data-rh=true property=og:description content="Welcome back! In the previous chapter, API Web Server (Express.js), we learned how our events-api uses Express.js as its front door to receive requests from the outside world (like users or other applications). Express listens for requests, routes them to the right place, and uses middleware for initial processing like logging or parsing data."><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://events.gbsl.website/docs/dev/events-api/access_control__authentication___authorization__><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/access_control__authentication___authorization__ hreflang=de-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/fr/docs/dev/events-api/access_control__authentication___authorization__ hreflang=fr-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/access_control__authentication___authorization__ hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://events.gbsl.website/docs/dev/events-api/","name":"Tutorial: events-api","position":1},{"@type":"ListItem","item":"https://events.gbsl.website/docs/dev/events-api/access_control__authentication___authorization__","name":"Chapter 4: Access Control (Authentication & Authorization)","position":2}]}</script><link rel=icon href=/img/logo.png><link rel=manifest href=/manifest.json><meta name=theme-color content="rgb(0, 20, 117)"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/img/logo_x512.png><link rel=mask-icon href=/img/logo-light.svg color="rgb(0, 20, 117)"><meta name=msapplication-TileImage content=/img/logo_x512.png><meta name=msapplication-TileColor content=#000><script src="https://app.ruttl.com/plugin.js?id=zkNcmoSeOgS1ykIZJ5fl&e=1" id=ruttl-site-embed-script async defer></script><script src=https://umami.gbsl.website/tell-me.js data-website-id=575c1e8d-3c6d-45d9-a716-f7ad146761ab data-domains=events.gbsl.website async defer></script><link rel=stylesheet href=/assets/css/styles.b0019c1c.css><script src=/assets/js/runtime~main.3f0a3638.js defer></script><script src=/assets/js/main.7f175059.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id=__docusaurus><link rel=preload as=image href=/img/logo.svg><div data--isauthenticated=false></div><div role=region aria-label="Zum Hauptinhalt springen"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Zum Hauptinhalt springen</a></div><div class="theme-announcement-bar announcementBar_mb4j" style=background-color:var(--color-current-week-odd-background);color:var(--ifm-font-color-base) role=banner><div class=announcementBarPlaceholder_vyr4></div><div class="content_knG7 announcementBarContent_xLdY">EinfÃ¼hrungsphase: rc-1.6</div><button type=button aria-label=SchlieÃŸen class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width=14 height=14><g stroke=currentColor stroke-width=3.1><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"/></g></svg></button></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Events</b></a><a class="navbar__item navbar__link" href=/calendar>Kalender</a><a class="navbar__item navbar__link" href=/table>Tabelle</a><a class="navbar__item navbar__link" href=/gantt>Zeitachse</a><a class="navbar__item navbar__link" href=/subscribe>Abonnieren</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs>?</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>Deutsch</a><ul class=dropdown__menu><li><a href=/docs/dev/events-api/access_control__authentication___authorization__ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=de-CH>Deutsch</a><li><a href=/fr/docs/dev/events-api/access_control__authentication___authorization__ target=_self rel="noopener noreferrer" class=dropdown__link lang=fr-CH>FranÃ§ais</a></ul></div><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem;transform:scaleX(-1);transform-origin:center role=presentation><style>@keyframes spin-inverse{0%{transform:rotate(0)}to{transform:rotate(-360deg)}}</style><g style="animation:spin-inverse linear 2s infinite;transform-origin:center"><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z" style=fill:var(--ifm-color-primary) /></g></svg><div class=""><span aria-describedby=popup-58><span style=display:inline-block aria-describedby=popup-59><button type=button class="button__qfG reducedPadding_vpuK iconRight_alf5 button button--outline button--primary"><span class=spacer_lB2W></span><span class=icon_Ceyd><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem role=presentation><path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" style=fill:currentColor /></svg></span><span class=spacer_lB2W></span></button></span></span></div><div><a href=/login>Login ðŸ”‘</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="System Modus" aria-label="Umschalten zwischen dunkler und heller Ansicht (momentan System Modus)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="ZurÃ¼ck nach oben scrollen" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs>Terminplan</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/login>Anmelden</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/events>Termine</a><button aria-label="Expand sidebar category 'Termine'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/betaphase>EinfÃ¼hrungsphase</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true href=/docs/dev/intro>API Reference</a></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/intro>Events App</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/authentication>User Authentication</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/database>Database</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/dev/events-api>Tutorial: events-api</a><button aria-label="Collapse sidebar category 'Tutorial: events-api'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/database_orm__prisma__>Chapter 1: Database ORM (Prisma)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/data_logic__models__>Chapter 2: Data Logic (Models)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/api_web_server__express_js__>Chapter 3: API Web Server (Express.js)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/dev/events-api/access_control__authentication___authorization__>Chapter 4: Access Control (Authentication & Authorization)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/request_handlers__controllers__>Chapter 5: Request Handlers (Controllers)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/external_data_sync_>Chapter 6: External Data Sync</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/background_task_runner__bree__>Chapter 7: Background Task Runner (Bree)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/real_time_communication__socket_io__>real_time_communication__socket_io__</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/notifications__email___socket_io__>Chapter 9: Notifications (Email & Socket.IO)</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/guide-fr>Mode d'emploi FR</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/dev/scenes>Scenes</a><button aria-label="Expand sidebar category 'Scenes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/docs/dev/services/ics/images>Services</a></div></ul></ul></nav><button type=button title="Seitenleiste einklappen" aria-label="Seitenleiste einklappen" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>API Reference</span><li class=breadcrumbs__item><a class=breadcrumbs__link href=/docs/dev/events-api><span>Tutorial: events-api</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Chapter 4: Access Control (Authentication & Authorization)</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">Auf dieser Seite</button></div><div class="theme-doc-markdown markdown"><header><h1>Chapter 4: Access Control (Authentication & Authorization)</h1></header>
<p>Welcome back! In the previous chapter, <a href=/docs/dev/events-api/api_web_server__express_js__>API Web Server (Express.js)</a>, we learned how our <code>events-api</code> uses Express.js as its front door to receive requests from the outside world (like users or other applications). Express listens for requests, routes them to the right place, and uses middleware for initial processing like logging or parsing data.</p>
<p>Express is great at <em>receiving</em> requests, but it doesn't automatically know <em>who</em> is making the request or <em>what</em> they should be allowed to do. When someone asks to, say, "create a new event," how do we know they're registered? And even if they are, are they allowed to create <em>any</em> event, or only certain types?</p>
<p>This is where <strong>Access Control</strong> comes in. It's about protecting our API's resources and functionality.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-security-guard-analogy>The Security Guard Analogy<a href=#the-security-guard-analogy class=hash-link aria-label="Direkter Link zur The Security Guard Analogy" title="Direkter Link zur The Security Guard Analogy">â€‹</a></h2>
<p>Think about our API building again. Express is the receptionist. But we also need security:</p>
<ol>
<li>
<p><strong>Authentication (The Security Guard at the Entrance):</strong> This is the process of verifying <em>who</em> someone is. It's like showing your ID badge to the guard at the building entrance. They check your ID against a list or system to confirm you are who you say you are.</p>
<ul>
<li><em>Question it answers:</em> "Who are you?"</li>
<li><em>Example:</em> A user logs in with an email and password (or via a service like Microsoft/Azure AD, as used in this project). The API verifies these credentials.</li>
<li><em>Result:</em> If successful, the API knows the user's identity (e.g., their unique ID, their name, their email).</li>
</ul>
</li>
<li>
<p><strong>Authorization (The Access Card/Rules for Different Rooms):</strong> Once the security guard at the entrance knows <em>who</em> you are, authorization checks <em>what</em> you are allowed to do and access <em>within</em> the building. It's like your ID badge (or access card) having different permissions â€“ maybe it lets you into the archive room, but not the manager's office, or maybe it only lets you <em>read</em> documents in the archive, but not <em>write</em> new ones.</p>
<ul>
<li><em>Question it answers:</em> "What are you allowed to do?"</li>
<li><em>Example:</em> An authenticated user tries to create a new event. The API checks if users with their role (e.g., <code>USER</code>, <code>ADMIN</code>) have permission to perform a <code>POST</code> request on the <code>/events</code> path.</li>
<li><em>Result:</em> If authorized, the user can proceed with their request. If not, the request is denied.</li>
</ul>
</li>
</ol>
<p>In our <code>events-api</code> project, Access Control combines Authentication and Authorization to ensure:</p>
<ul>
<li>Only known users can access certain parts of the API (Authentication).</li>
<li>Known users can only perform actions they are permitted to do based on their role and the specific resource (Authorization).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=our-use-case-controlling-who-can-create-events>Our Use Case: Controlling Who Can Create Events<a href=#our-use-case-controlling-who-can-create-events class=hash-link aria-label="Direkter Link zur Our Use Case: Controlling Who Can Create Events" title="Direkter Link zur Our Use Case: Controlling Who Can Create Events">â€‹</a></h2>
<p>Let's use a simple, concrete example: <strong>Creating a new event.</strong></p>
<ul>
<li>A regular user (<code>Role.USER</code>) should be able to <em>create</em> events they are involved in or author.</li>
<li>An administrator (<code>Role.ADMIN</code>) should also be able to create events.</li>
<li>Someone who is <em>not logged in</em> (an anonymous or 'PUBLIC' user) should <em>not</em> be able to create events.</li>
</ul>
<p>So, when a <code>POST</code> request arrives at the <code>/api/v1/events</code> path, we need to:</p>
<ol>
<li>Check if the requester is authenticated (logged in). If not, deny access.</li>
<li>If authenticated, check if their role (<code>USER</code> or <code>ADMIN</code>) is allowed to make a <code>POST</code> request to <code>/api/v1/events</code>. If not, deny access.</li>
</ol>
<p>This check needs to happen <em>before</em> the code that actually creates the event in the database is executed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=access-control-in-the-server-pipeline>Access Control in the Server Pipeline<a href=#access-control-in-the-server-pipeline class=hash-link aria-label="Direkter Link zur Access Control in the Server Pipeline" title="Direkter Link zur Access Control in the Server Pipeline">â€‹</a></h2>
<p>Remember the middleware pipeline in <code>src/app.ts</code> from Chapter 3? This is where our Access Control steps are placed.</p>
<p>The request goes through several middleware functions <em>before</em> reaching the specific Request Handler (Controller) that fulfills the request's purpose (<code>allEvents</code> or <code>createEvent</code>, etc.). Authentication and Authorization middleware are key parts of this pipeline.</p>
<p>Here's a simplified look at the relevant part of <code>src/app.ts</code> again:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\app.ts - Focusing on Authentication and Authorization Middleware</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> express </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports like cors, express.json, morganMiddleware ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Passport is used for Authentication (Who are you?)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> passport </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'passport'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// routeGuard is used for Authorization (What are you allowed to do?)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> routeGuard</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> createAccessRules </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./auth/guard'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> authConfig </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./routes/authConfig'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Defines the rules</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> router </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./routes/router'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The router with specific handlers</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> app </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>express</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>API_URL</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>/api/v1</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Our API prefix</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Load access rules from authConfig</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> AccessRules </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>createAccessRules</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">authConfig</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">accessMatrix</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other general middleware (cors, express.json, morganMiddleware, session) ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">app</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">passport</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>initialize</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Initialize passport authentication</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">app</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">passport</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>session</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Enable passport to use sessions</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Authentication and Authorization are applied to routes under /api/v1</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">app</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation constant" style=color:#36acaa>API_URL</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// --- Authentication Step ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If user is already authenticated (e.g., from session), proceed</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>isAuthenticated</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Otherwise, try to authenticate using the configured strategy (like OAuth/Azure AD)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        passport</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>authenticate</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'oauth-bearer'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> session</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> user</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> info</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>!</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 </span><span class="token comment" style=color:#999988;font-style:italic>// If authentication fails, send 401 Unauthorized response</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>401</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>json</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> error</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> err </span><span class="token operator" style=color:#393A34>?</span><span class="token plain"> err</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">message </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Unauthorized"</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token comment" style=color:#999988;font-style:italic>// If authentication succeeds, attach the user to the request</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> user</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token comment" style=color:#999988;font-style:italic>// Authentication passed, move to the next middleware (Authorization)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// This part is a bit advanced Express, just know it runs the authentication logic</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// --- Authorization Step ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>routeGuard</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">AccessRules</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Check if the authenticated user is allowed to access this route</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// --- If both pass, proceed to the Router ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    router </span><span class="token comment" style=color:#999988;font-style:italic>// Handles the specific request (e.g., calling the createEvent controller)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... error handling middleware ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>default</span><span class="token plain"> app</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>app.use(passport.initialize())</code> and <code>app.use(passport.session())</code>: These lines set up the Passport library, which handles the Authentication step. Passport is configured elsewhere (<code>src/auth/index.ts</code>, <code>src/auth/azure-ad.ts</code>, <code>src/auth/mock.ts</code>) to understand <em>how</em> to verify a user (e.g., by checking credentials or tokens). If successful, Passport attaches information about the authenticated user to the request object, typically as <code>req.user</code>.</li>
<li>The first function inside <code>app.use(`${API_URL}`, ...)</code> is our custom authentication check using Passport. It tries to authenticate the user. If it fails (no user found or an error), it stops the request and sends a <code>401 Unauthorized</code> response. If successful, it calls <code>next()</code> to move to the next middleware.</li>
<li><code>routeGuard(AccessRules)</code>: This is the Authorization middleware. It's called <em>only if</em> the user was successfully authenticated in the previous step (or if the route is public like <code>GET /events</code>). It uses the <code>AccessRules</code> (loaded from <code>authConfig.ts</code>) to check if the authenticated user (<code>req.user</code>) has the <em>required role</em> to access the requested <em>path</em> using the requested <em>HTTP method</em> (<code>POST</code> for <code>/events</code> in our use case).</li>
<li>If <code>routeGuard</code> determines the user is <em>not</em> authorized, it stops the request and sends a <code>403 Forbidden</code> response.</li>
<li>If <code>routeGuard</code> determines the user <em>is</em> authorized, or if the route is explicitly public (like fetching all public events via <code>GET /events</code>), it calls <code>next()</code>, and the request finally proceeds to the <code>router</code>, which will then call the appropriate Request Handler (Controller) like <code>createEvent</code>.</li>
</ol>
<p>This middleware setup ensures that every request targeting the <code>/api/v1</code> routes is subjected to Authentication and Authorization checks <em>before</em> the core logic for that route is accessed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=under-the-hood-how-routeguard-authorizes>Under the Hood: How <code>routeGuard</code> Authorizes<a href=#under-the-hood-how-routeguard-authorizes class=hash-link aria-label="Direkter Link zur under-the-hood-how-routeguard-authorizes" title="Direkter Link zur under-the-hood-how-routeguard-authorizes">â€‹</a></h2>
<p>Let's dive a bit deeper into how <code>routeGuard</code> works, specifically looking at <code>src/auth/guard.ts</code> and <code>src/routes/authConfig.ts</code>.</p>
<p>The core of authorization is the <code>AccessRules</code> object, which acts like a master list of permissions. It's generated from the <code>accessMatrix</code> defined in <code>src/routes/authConfig.ts</code>.</p>
<p>Here's a simplified look at <code>src/routes/authConfig.ts</code>:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\routes\authConfig.ts - Defines Access Rules</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Role </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'@prisma/client'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Roles are defined by Prisma based on our schema</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>interface</span><span class="token plain"> </span><span class="token class-name">AccessMatrix</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">key</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        path</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The API path (can include parameters like :id)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        access</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            methods</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'GET'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'POST'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'PUT'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'DELETE'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Allowed methods for this rule</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            roles</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Role</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Roles that are allowed for these methods and path</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> authConfig</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> accessMatrix</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> AccessMatrix</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/*...*/</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    accessMatrix</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Rule for seeing if a user is logged in</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        checklogin</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            path</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'/checklogin'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            access</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> methods</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>'GET'</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> roles</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ADMIN</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>USER</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Both ADMIN and USER can GET this</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Rule for accessing/creating/updating/deleting events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        event</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            path</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'/events'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Applies to /api/v1/events and /api/v1/events/:id</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            access</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> methods</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>'GET'</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> roles</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ADMIN</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>USER</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// ADMIN and USER can GET (list/find) events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> methods</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>'POST'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'PUT'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'DELETE'</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> roles</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ADMIN</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>USER</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// ADMIN and USER can POST, PUT, DELETE events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token comment" style=color:#999988;font-style:italic>// Note: The User role might have further checks *within* the Controller/Model</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token comment" style=color:#999988;font-style:italic>// for *which specific* event they can modify (their own, etc.).</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token comment" style=color:#999988;font-style:italic>// The routeGuard checks the *general* permission for the path/method.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Rule for modifying user roles (only admins)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        userSetRole</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            path</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'/users/:id/set_role'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Specific path for changing roles</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            access</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> methods</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>'PUT'</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> roles</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">Role</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ADMIN</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// ONLY ADMIN can PUT to this path</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// ... many other rules for different paths ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ... other config like credentials, metadata, settings ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>default</span><span class="token plain"> authConfig</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ul>
<li>The <code>accessMatrix</code> defines rules based on <code>path</code> and the actions (<code>methods</code>) allowed for different <code>roles</code>.</li>
<li>Under the <code>event</code> key, the <code>path: '/events'</code> entry covers both the list endpoint (<code>/events</code>) and the detail endpoint (<code>/events/:id</code>) due to how <code>routeGuard</code> matches paths.</li>
<li>It specifies that <code>GET</code> is allowed for both <code>ADMIN</code> and <code>USER</code> roles.</li>
<li>It also specifies that <code>POST</code>, <code>PUT</code>, and <code>DELETE</code> are allowed for both <code>ADMIN</code> and <code>USER</code> roles. (As noted in the comment, finer-grained "Can user X edit event Y?" checks still happen in the Model/Controller, but the <code>routeGuard</code> gives the initial permission based on role and path/method).</li>
<li>Contrast this with <code>userSetRole</code>: only <code>ADMIN</code> is listed for the <code>PUT</code> method on that specific path.</li>
</ul>
<p>Now, let's see (simplified) how <code>routeGuard</code> in <code>src/auth/guard.ts</code> uses these rules:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\auth\guard.ts - The routeGuard logic</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>type</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Role </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'@prisma/client'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Response</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> NextFunction </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> HttpStatusCode </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../utils/errors/BaseError'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// AccessRules is the processed version of the matrix from authConfig</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> createAccessRules</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>PUBLIC_ROUTES</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/authConfig'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... helper functions like createAccessRules and regexFromRoute ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> routeGuard </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">accessMatrix</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Simplified: it's Array&lt;AccessRegexRule> */</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// This inner function IS the middleware called by Express *after* Authentication</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Response</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> NextFunction</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> reqPath </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">path</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>toLowerCase</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> reqMethod </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">method </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'GET'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'POST'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'PUT'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'DELETE'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> user </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> role</span><span class="token operator" style=color:#393A34>?</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Role </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>undefined</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Get the authenticated user (or undefined if not)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Check 1: Allow Public GET requests ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Some routes are public (like GET /events to see published events).</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// We check if the path is in the list of public routes OR matches a public regex route.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> isPublicGet </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> reqMethod </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'GET'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&&</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                            </span><span class="token punctuation" style=color:#393A34>(</span><span class="token constant" style=color:#36acaa>PUBLIC_ROUTES</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>includes</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">reqPath</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* checks against regex for :id paths */</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">isPublicGet</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">           </span><span class="token comment" style=color:#999988;font-style:italic>// If it's a public GET route, allow it even if user is not logged in</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">           </span><span class="token comment" style=color:#999988;font-style:italic>// Note: The actual data returned for public GETs might be filtered later by the Model</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">           </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Check 2: Require Authentication for Non-Public Routes ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If it's not a public GET route, the user *must* be authenticated.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>!</span><span class="token plain">user </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>!</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">role</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// If no user is attached to the request (means authentication failed or didn't happen for non-public route)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">HttpStatusCode</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FORBIDDEN</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>json</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> error</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'Authentication required'</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Check 3: Authorization based on Role and Access Rules ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// User is authenticated. Now check if their role has permission for this path and method.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> isAuthorized </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>requestHasRequiredAttributes</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">accessMatrix</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> reqPath</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> reqMethod</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">role</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">isAuthorized</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// User is authorized! Proceed to the next middleware (likely the router/controller)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// User is authenticated but NOT authorized for this specific action</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">HttpStatusCode</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FORBIDDEN</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>json</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> error</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'User does not have required role or permission'</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token doc-comment comment" style=color:#999988;font-style:italic>/**</span><br></span><span class=token-line style=color:#393A34><span class="token doc-comment comment" style=color:#999988;font-style:italic> * Simplified helper function to check if the user's role is allowed</span><br></span><span class=token-line style=color:#393A34><span class="token doc-comment comment" style=color:#999988;font-style:italic> * for this path and method according to the access matrix.</span><br></span><span class=token-line style=color:#393A34><span class="token doc-comment comment" style=color:#999988;font-style:italic> */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> requestHasRequiredAttributes </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    accessMatrix</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token class-name">path</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    method</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    userRole</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Role</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Find the specific rule in the accessMatrix that matches the requested path</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// (This involves regex matching for paths with parameters like :id - simplified here)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> accessRule </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> accessMatrix</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>find</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* logic to find matching rule for path */</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// If no rule is found for this path, deny access by default (could also be a 404 error)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>!</span><span class="token plain">accessRule</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>false</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Check if the user's role is present in the allowed roles list</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// for the requested method within the found access rule.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> hasPermission </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> accessRule</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">access</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>some</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">rulePart</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified type inside access array</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            rulePart</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">roles</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>includes</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">userRole</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&&</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Does this rule part include the user's role?</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            rulePart</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">methods</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>includes</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">method</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">   </span><span class="token comment" style=color:#999988;font-style:italic>// Does this rule part include the requested method?</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> hasPermission</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>default</span><span class="token plain"> routeGuard</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>routeGuard</code> is the middleware function called by Express. It receives the <code>req</code>, <code>res</code>, and <code>next</code> objects.</li>
<li>It first checks if the request is for a <code>GET</code> request on a publicly allowed path (<code>isPublicGet</code>). If so, it calls <code>next()</code> immediately, bypassing the authentication/authorization checks for logged-in users.</li>
<li>If it's <em>not</em> a public GET, it checks if <code>req.user</code> exists and has a <code>role</code>. If not, authentication failed or wasn't performed for a non-public route, so it sends a <code>403 Forbidden</code> (or <code>401</code> in the <code>app.ts</code> middleware) response.</li>
<li>If authentication passed, it calls <code>requestHasRequiredAttributes</code>, passing the loaded <code>accessMatrix</code>, the requested <code>path</code>, <code>method</code>, and the <code>user.role</code>.</li>
<li><code>requestHasRequiredAttributes</code> looks up the specific rule defined in <code>authConfig</code> that best matches the requested path.</li>
<li>It then checks if that rule allows the user's <code>role</code> to perform the requested <code>method</code>.</li>
<li>Based on the result, <code>routeGuard</code> either calls <code>next()</code> (authorized) or sends a <code>403 Forbidden</code> response (authenticated but not authorized).</li>
</ol>
<p>This layered approach means that for our "create event" use case (<code>POST /api/v1/events</code>):</p>
<ul>
<li>First, the authentication middleware checks if the user is logged in (<code>req.isAuthenticated()</code>, using Passport). If not, <code>401 Unauthorized</code>.</li>
<li>If logged in, <code>req.user</code> is available.</li>
<li>The <code>routeGuard</code> middleware is called. It sees it's a <code>POST</code> request (not a public GET). It checks if the user is authenticated (<code>req.user</code>). Yes.</li>
<li>It then calls <code>requestHasRequiredAttributes</code> with <code>req.path='/events'</code>, <code>req.method='POST'</code>, and <code>userRole</code> (either <code>USER</code> or <code>ADMIN</code>).</li>
<li><code>requestHasRequiredAttributes</code> looks up the <code>/events</code> rule in the access matrix. It finds the entry <code>{ methods: ['POST', 'PUT', 'DELETE'], roles: [Role.ADMIN, Role.USER] }</code>.</li>
<li>It checks if the user's role (<code>USER</code> or <code>ADMIN</code>) is in <code>[Role.ADMIN, Role.USER]</code> and if the method <code>POST</code> is in <code>['POST', 'PUT', 'DELETE']</code>. Both are true for either <code>USER</code> or <code>ADMIN</code>.</li>
<li><code>requestHasRequiredAttributes</code> returns <code>true</code>.</li>
<li><code>routeGuard</code> receives <code>true</code> and calls <code>next()</code>.</li>
<li>The request proceeds to the <code>router</code> and the <code>createEvent</code> controller.</li>
</ul>
<p>If an anonymous user (no <code>req.user</code>) tried <code>POST /api/v1/events</code>, the authentication middleware would fail and send <code>401 Unauthorized</code>. If a logged-in user with a different role (e.g., a hypothetical <code>VIEWER</code> role <em>not</em> in <code>[Role.ADMIN, Role.USER]</code> for the POST method) tried it, <code>requestHasRequiredAttributes</code> would return <code>false</code>, and <code>routeGuard</code> would send <code>403 Forbidden</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-flow-with-access-control>The Flow with Access Control<a href=#the-flow-with-access-control class=hash-link aria-label="Direkter Link zur The Flow with Access Control" title="Direkter Link zur The Flow with Access Control">â€‹</a></h2>
<p>Let's update our sequence diagram to include the Authentication and Authorization steps.</p>
<!-- -->
<p>This diagram clearly shows that Authentication and Authorization are crucial gates that the request must pass through <em>before</em> it gets to the code responsible for carrying out the requested action (Controller, Model, Prisma, DB).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direkter Link zur Conclusion" title="Direkter Link zur Conclusion">â€‹</a></h2>
<p>Access Control, divided into Authentication (proving who you are) and Authorization (checking what you can do), is fundamental to securing our <code>events-api</code>. With Express.js, we implement this as middleware layers that process every request before it reaches the core business logic. Passport handles the initial authentication, identifying the user and attaching their information to the request. Our custom <code>routeGuard</code> middleware then uses a defined set of <code>AccessRules</code> (<code>authConfig.ts</code>) to determine if the authenticated user's role is permitted to access the specific path and HTTP method requested. If either authentication or authorization fails, the request is stopped early, preventing unauthorized actions. Only if both checks pass does the request continue down the pipeline to the functional code that handles the request, which we call Request Handlers or Controllers.</p>
<p>Now that we've covered how requests are received, processed by middleware (including security checks), and directed, we're ready to look at the specific code that actually <em>handles</em> these requests and uses our Models to interact with the data.</p>
<p><a href=/docs/dev/events-api/request_handlers__controllers__>Next Chapter: Request Handlers (Controllers)</a></p>
<hr>
<p>Generated by <a href=https://github.com/The-Pocket/Tutorial-Codebase-Knowledge target=_blank rel="noopener noreferrer">AI Codebase Knowledge Builder</a></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/lebalz/events-app/edit/main/10-dev/events-api/04_access_control__authentication___authorization__.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Diese Seite bearbeiten</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Dokumentation Seiten"><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/dev/events-api/api_web_server__express_js__><div class=pagination-nav__sublabel>ZurÃ¼ck</div><div class=pagination-nav__label>Chapter 3: API Web Server (Express.js)</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/dev/events-api/request_handlers__controllers__><div class=pagination-nav__sublabel>Weiter</div><div class=pagination-nav__label>Chapter 5: Request Handlers (Controllers)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#the-security-guard-analogy class="table-of-contents__link toc-highlight">The Security Guard Analogy</a><li><a href=#our-use-case-controlling-who-can-create-events class="table-of-contents__link toc-highlight">Our Use Case: Controlling Who Can Create Events</a><li><a href=#access-control-in-the-server-pipeline class="table-of-contents__link toc-highlight">Access Control in the Server Pipeline</a><li><a href=#under-the-hood-how-routeguard-authorizes class="table-of-contents__link toc-highlight">Under the Hood: How <code>routeGuard</code> Authorizes</a><li><a href=#the-flow-with-access-control class="table-of-contents__link toc-highlight">The Flow with Access Control</a><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div><div id=popup-root></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Events</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/calendar>Kalender</a><li class=footer__item><a class=footer__link-item href=/table>Tabelle</a><li class=footer__item><a class=footer__link-item href=/gantt>Gantt</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Admin</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/admin>Dashboard</a><li class=footer__item><a class=footer__link-item href=/import>Import</a><li class=footer__item><a class=footer__link-item href=/docs>Dokumentation</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Links</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.gbsl.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBSL<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://gbjb.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBJB<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://github.com/lebalz/events-app target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://admin.socket.io/ target=_blank rel="noopener noreferrer" class=footer__link-item>Socket.IO Dashboard<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright Â© 2025 B. Hofer <br>
          <span class=translator-de>Ãœbersetzt von G. Andonie</span><br>
          <a class="badge badge--primary" href=https://github.com/lebalz/events-app/commit/f1de6272fc8966d6c8080dabb5333feddd2d65c1>
            áš¶ f1de627
          </a>
          </div></div></div></footer></div>