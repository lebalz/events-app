<!doctype html><html lang=de-CH dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/events-api/notifications__email___socket_io__" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.0"><title data-rh=true>Chapter 9: Notifications (Email & Socket.IO) | Events</title><meta data-rh=true property=og:image content=https://events.gbsl.website/img/og-preview.jpeg><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://events.gbsl.website/docs/dev/events-api/notifications__email___socket_io__><meta data-rh=true property=og:locale content=de_CH><meta data-rh=true property=og:locale:alternate content=fr_CH><meta data-rh=true name=docusaurus_locale content=de><meta data-rh=true name=docsearch:language content=de><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Chapter 9: Notifications (Email & Socket.IO) | Events"><meta data-rh=true name=description content="Welcome back! In our previous chapter, Real-time Communication (Socket.IO), we learned how our events-api uses Socket.IO to send instant updates to connected clients, like a live news ticker in a web app. This is great for showing changes right away on a user's screen."><meta data-rh=true property=og:description content="Welcome back! In our previous chapter, Real-time Communication (Socket.IO), we learned how our events-api uses Socket.IO to send instant updates to connected clients, like a live news ticker in a web app. This is great for showing changes right away on a user's screen."><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://events.gbsl.website/docs/dev/events-api/notifications__email___socket_io__><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/notifications__email___socket_io__ hreflang=de-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/fr/docs/dev/events-api/notifications__email___socket_io__ hreflang=fr-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/notifications__email___socket_io__ hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://events.gbsl.website/docs/dev/events-api/","name":"Tutorial: events-api","position":1},{"@type":"ListItem","item":"https://events.gbsl.website/docs/dev/events-api/notifications__email___socket_io__","name":"Chapter 9: Notifications (Email & Socket.IO)","position":2}]}</script><link rel=icon href=/img/logo.png><link rel=manifest href=/manifest.json><meta name=theme-color content="rgb(0, 20, 117)"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/img/logo_x512.png><link rel=mask-icon href=/img/logo-light.svg color="rgb(0, 20, 117)"><meta name=msapplication-TileImage content=/img/logo_x512.png><meta name=msapplication-TileColor content=#000><script src="https://app.ruttl.com/plugin.js?id=zkNcmoSeOgS1ykIZJ5fl&e=1" id=ruttl-site-embed-script async defer></script><script src=https://umami.gbsl.website/tell-me.js data-website-id=575c1e8d-3c6d-45d9-a716-f7ad146761ab data-domains=events.gbsl.website async defer></script><link rel=stylesheet href=/assets/css/styles.1aee9570.css><script src=/assets/js/runtime~main.a3f045c0.js defer></script><script src=/assets/js/main.0cba21a5.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id=__docusaurus><link rel=preload as=image href=/img/logo.svg><div data--isauthenticated=false></div><div role=region aria-label="Zum Hauptinhalt springen"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Zum Hauptinhalt springen</a></div><div class="theme-announcement-bar announcementBar_mb4j" style=background-color:var(--color-current-week-odd-background);color:var(--ifm-font-color-base) role=banner><div class=announcementBarPlaceholder_vyr4></div><div class="content_knG7 announcementBarContent_xLdY">EinfÃ¼hrungsphase: rc-1.6</div><button type=button aria-label=SchlieÃŸen class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width=14 height=14><g stroke=currentColor stroke-width=3.1><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"/></g></svg></button></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Events</b></a><a class="navbar__item navbar__link" href=/calendar>Kalender</a><a class="navbar__item navbar__link" href=/table>Tabelle</a><a class="navbar__item navbar__link" href=/gantt>Zeitachse</a><a class="navbar__item navbar__link" href=/subscribe>Abonnieren</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs>?</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>Deutsch</a><ul class=dropdown__menu><li><a href=/docs/dev/events-api/notifications__email___socket_io__ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=de-CH>Deutsch</a><li><a href=/fr/docs/dev/events-api/notifications__email___socket_io__ target=_self rel="noopener noreferrer" class=dropdown__link lang=fr-CH>FranÃ§ais</a></ul></div><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem;transform:scaleX(-1);transform-origin:center role=presentation><style>@keyframes spin-inverse{0%{transform:rotate(0)}to{transform:rotate(-360deg)}}</style><g style="animation:spin-inverse linear 2s infinite;transform-origin:center"><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z" style=fill:var(--ifm-color-primary) /></g></svg><div class=""><span aria-describedby=popup-71><span style=display:inline-block aria-describedby=popup-72><button type=button class="button__qfG reducedPadding_vpuK iconRight_alf5 button button--outline button--primary"><span class=spacer_lB2W></span><span class=icon_Ceyd><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem role=presentation><path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" style=fill:currentColor /></svg></span><span class=spacer_lB2W></span></button></span></span></div><div><a href=/login>Login ðŸ”‘</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="System Modus" aria-label="Umschalten zwischen dunkler und heller Ansicht (momentan System Modus)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="ZurÃ¼ck nach oben scrollen" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs>Terminplan</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/login>Anmelden</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/events>Termine</a><button aria-label="Expand sidebar category 'Termine'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/betaphase>EinfÃ¼hrungsphase</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true href=/docs/dev/intro>API Reference</a></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/intro>Events App</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/authentication>User Authentication</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/database>Database</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/dev/events-api>Tutorial: events-api</a><button aria-label="Collapse sidebar category 'Tutorial: events-api'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/database_orm__prisma__>Chapter 1: Database ORM (Prisma)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/data_logic__models__>Chapter 2: Data Logic (Models)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/api_web_server__express_js__>Chapter 3: API Web Server (Express.js)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/access_control__authentication___authorization__>Chapter 4: Access Control (Authentication & Authorization)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/request_handlers__controllers__>Chapter 5: Request Handlers (Controllers)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/external_data_sync_>Chapter 6: External Data Sync</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/background_task_runner__bree__>Chapter 7: Background Task Runner (Bree)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/real_time_communication__socket_io__>real_time_communication__socket_io__</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/dev/events-api/notifications__email___socket_io__>Chapter 9: Notifications (Email & Socket.IO)</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/guide-fr>Mode d'emploi FR</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/dev/scenes>Scenes</a><button aria-label="Expand sidebar category 'Scenes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/docs/dev/services/ics/images>Services</a></div></ul></ul></nav><button type=button title="Seitenleiste einklappen" aria-label="Seitenleiste einklappen" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>API Reference</span><li class=breadcrumbs__item><a class=breadcrumbs__link href=/docs/dev/events-api><span>Tutorial: events-api</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Chapter 9: Notifications (Email & Socket.IO)</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">Auf dieser Seite</button></div><div class="theme-doc-markdown markdown"><header><h1>Chapter 9: Notifications (Email & Socket.IO)</h1></header>
<p>Welcome back! In our previous chapter, <a href=/docs/dev/events-api/real_time_communication__socket_io__>Real-time Communication (Socket.IO)</a>, we learned how our <code>events-api</code> uses Socket.IO to send instant updates to connected clients, like a live news ticker in a web app. This is great for showing changes right away on a user's screen.</p>
<p>But sometimes, an instant notification isn't enough, or the user might not be online or have the application open. What if an essential event they planned to attend is suddenly cancelled? They need to know about that crucial change reliably, even if they aren't actively looking at the app interface.</p>
<p>This is where a more comprehensive <strong>Notification System</strong> comes in. Its purpose is to inform users about important status changes, updates, or deletions related to events and other relevant data. It acts as the application's built-in communication manager, ensuring relevant people are alerted when something significant happens.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=not-just-a-ticker-a-multi-channel-alert-system>Not Just a Ticker: A Multi-Channel Alert System<a href=#not-just-a-ticker-a-multi-channel-alert-system class=hash-link aria-label="Direkter Link zur Not Just a Ticker: A Multi-Channel Alert System" title="Direkter Link zur Not Just a Ticker: A Multi-Channel Alert System">â€‹</a></h2>
<p>Think of our application managing events. When an event is created, updated, or deleted, or when its review status changes (like from <code>REVIEW</code> to <code>PUBLISHED</code> or <code>REFUSED</code>), different users might need to be informed:</p>
<ul>
<li>The event's author.</li>
<li>Users who are affected by the event (e.g., students or teachers whose lessons are impacted).</li>
<li>Administrators who need to review events.</li>
<li>Users who have subscribed to notifications about event changes.</li>
</ul>
<p>The best way to reach these different users and provide the right level of detail often requires more than just an in-app message.</p>
<p>Our notification system employs a dual approach:</p>
<ol>
<li><strong>Socket.IO Notifications:</strong> For immediate, real-time updates within the connected application interface. This is like the live news ticker we discussed in the last chapter. It's ideal for showing a quick alert or updating a list dynamically.</li>
<li><strong>Email Notifications:</strong> For external, asynchronous, and often more detailed communication. This is like getting a specific alert email about a major news story. It ensures the user receives the information even if they are offline and provides a persistent record.</li>
</ol>
<p>This dual strategy ensures that users are informed effectively, meeting both the need for instant feedback while using the app and reliable notification even when they aren't.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=our-use-case-notifying-users-when-an-event-is-deleted>Our Use Case: Notifying Users When an Event is Deleted<a href=#our-use-case-notifying-users-when-an-event-is-deleted class=hash-link aria-label="Direkter Link zur Our Use Case: Notifying Users When an Event is Deleted" title="Direkter Link zur Our Use Case: Notifying Users When an Event is Deleted">â€‹</a></h2>
<p>Let's consider the scenario where an administrator deletes a published event.</p>
<ul>
<li>The connected web application needs to know immediately so it can remove the event from any lists the user is viewing.</li>
<li>Users who were potentially affected by this event (e.g., those listed as attendees or whose timetable was impacted) should receive an email explaining that the event is cancelled.</li>
</ul>
<p>This requires triggering <em>both</em> a Socket.IO message <em>and</em> targeted emails for the same underlying data change.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=triggering-notifications-from-the-controller>Triggering Notifications from the Controller<a href=#triggering-notifications-from-the-controller class=hash-link aria-label="Direkter Link zur Triggering Notifications from the Controller" title="Direkter Link zur Triggering Notifications from the Controller">â€‹</a></h2>
<p>The notification process starts in the <strong>Request Handlers (Controllers)</strong> (<a href=/docs/dev/events-api/request_handlers__controllers__>Request Handlers (Controllers)</a>). After a Controller successfully performs an action that modifies data (like deleting an event via the Model), it decides which notifications are necessary.</p>
<p>In the <code>events-api</code>, Controllers handle this by:</p>
<ol>
<li><strong>Setting <code>res.notifications</code>:</strong> Adding objects to this special property on the Express response to signal that Socket.IO notifications should be sent. This is primarily for real-time updates to connected clients.</li>
<li><strong>Directly Calling Notification Services:</strong> Invoking specific functions from notification service modules (like <code>src/services/notifications/notifyUsers.ts</code>) to send emails.</li>
</ol>
<p>Let's revisit a simplified example of the <code>destroy</code> function in <code>src/controllers/events.ts</code> and see how it triggers both:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified snippet from src\controllers\events.ts - destroy function</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> RequestHandler </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Events </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../models/event'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Import the Events Model</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Import types for Socket.IO notifications</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Notification </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/socketEventTypes'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoRoom </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/socketEvents'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Import rooms</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Import service function for email notifications</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> notifyOnDelete </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../services/notifications/notifyUsers'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">Event</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Define type of record for notifications</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> destroy</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> RequestHandler</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>try</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// 1. Delegate the core task to the Model (deletes the event in the DB)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> deletedEvent </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> Events</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>destroy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token operator" style=color:#393A34>!</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">params</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Only send notifications for non-draft events that were actually deleted</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">deletedEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">state </span><span class="token operator" style=color:#393A34>!==</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'DRAFT'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&&</span><span class="token plain"> deletedEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">deletedAt</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// 2a. Add Socket.IO notification details to res.notifications</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// This will trigger a real-time message to connected clients</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">notifications </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// This object tells the Socket.IO post-processor what to send</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                    message</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> type</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> deletedEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Message payload: record type and ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                    event</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>DELETED_RECORD</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Socket.IO event type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                    </span><span class="token class-name">to</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoRoom</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ALL</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Send to all connected clients in the 'ALL' room</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// 2b. Directly call the email notification service</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// This function handles identifying relevant users and sending emails</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>notifyOnDelete</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">deletedEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token operator" style=color:#393A34>!</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// 3. Send the standard HTTP response</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>204</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>send</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// 204 No Content is typical for successful deletion</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>catch</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Pass any errors to the error handling middleware</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li>The controller calls <code>Events.destroy</code> on the <a href=/docs/dev/events-api/data_logic__models__>Model</a> to perform the database operation.</li>
<li>After successful deletion, it checks if notifications are needed (i.e., if the deleted event wasn't a draft and is marked as deleted).</li>
<li><code>res.notifications = [...]</code>: An array is assigned to <code>res.notifications</code>. This array contains objects structured according to the <code>Notification</code> interface (defined in <code>src/routes/socketEventTypes.ts</code>). This specific notification object tells the system to emit a <code>DELETED_RECORD</code> Socket.IO event with the event's type and ID, targeted at the <code>IoRoom.ALL</code> (all connected clients).</li>
<li><code>await notifyOnDelete(deletedEvent, req.user!);</code>: The controller directly calls the <code>notifyOnDelete</code> function from <code>src/services/notifications/notifyUsers.ts</code>. This function is specifically designed to handle the logic for sending emails when an event is deleted. It receives the details of the <code>deletedEvent</code> and the <code>actor</code> (the user who initiated the deletion) as arguments.</li>
</ol>
<p>This split approach allows <code>res.notifications</code> to act as a simple declaration for real-time events processed generically later, while dedicated email services (<code>notifyOnDelete</code>, <code>notifyOnUpdate</code>, etc.) contain the complex logic needed for email recipients and content.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=sending-socketio-notifications-recap>Sending Socket.IO Notifications (Recap)<a href=#sending-socketio-notifications-recap class=hash-link aria-label="Direkter Link zur Sending Socket.IO Notifications (Recap)" title="Direkter Link zur Sending Socket.IO Notifications (Recap)">â€‹</a></h2>
<p>As covered in the <a href=/docs/dev/events-api/real_time_communication__socket_io__>Real-time Communication (Socket.IO)</a> chapter, a dedicated post-processing step (middleware or handler after the controller) looks for the <code>res.notifications</code> property. If found, it iterates through the array and uses the <code>io</code> instance (which was attached to <code>req.io</code> in <code>src/server.ts</code>) and helper functions (like <code>notify</code> or <code>notifyDeletedRecord</code> from <code>src/routes/notify.ts</code>) to emit the specified Socket.IO events to the defined recipients (<code>to</code> field).</p>
<p>This ensures that as soon as the HTTP request finishes processing (and before the final response is sent back), connected clients get the real-time updates.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=sending-email-notifications>Sending Email Notifications<a href=#sending-email-notifications class=hash-link aria-label="Direkter Link zur Sending Email Notifications" title="Direkter Link zur Sending Email Notifications">â€‹</a></h2>
<p>Email notifications have a more complex flow because they involve external communication and require looking up user email addresses and potentially generating detailed content.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1-identifying-recipients-and-content-logic-srcservicesnotificationsnotifyusersts>1. Identifying Recipients and Content Logic (<code>src\services\notifications\notifyUsers.ts</code>)<a href=#1-identifying-recipients-and-content-logic-srcservicesnotificationsnotifyusersts class=hash-link aria-label="Direkter Link zur 1-identifying-recipients-and-content-logic-srcservicesnotificationsnotifyusersts" title="Direkter Link zur 1-identifying-recipients-and-content-logic-srcservicesnotificationsnotifyusersts">â€‹</a></h3>
<p>The service functions called directly by controllers (like <code>notifyOnDelete</code>, <code>notifyOnUpdate</code>, <code>notifyOnReviewRequest</code>, <code>notifyOnRefused</code>, <code>mailOnAccept</code> - used within <code>notifyOnUpdate</code>) contain the main logic for emails:</p>
<ul>
<li><strong>Who to email?</strong> This involves querying the database to find relevant users based on factors like:<!-- -->
<ul>
<li>Are they marked to receive notifications (<code>notifyOnEventUpdate</code> field on <code>User</code> model)?</li>
<li>Are they affected by the event change (using the <code>view_AffectedByEvents</code> Prisma view, which links users/classes/departments to events)?</li>
<li>Are they administrators (based on <code>Role</code>) and have enabled relevant admin notifications (<code>notifyAdminOnReviewRequest</code>, <code>notifyAdminOnReviewDecision</code>)?</li>
<li>Are they the author of the event?</li>
</ul>
</li>
<li><strong>What to email?</strong> This logic determines the subject line, main message, and content of the email, often structured as a table of event details or changes. Different functions generate content tailored to deletion, update, acceptance, refusal, or review requests.</li>
</ul>
<p>Let's look at a simplified snippet from <code>src\services\notifications\notifyUsers.ts</code>:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified snippet from src\services\notifications\notifyUsers.ts - notifyOnDelete</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> EventState</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> User </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'@prisma/client'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> ApiEvent </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../../models/event.helpers'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> prisma </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../../prisma'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Need Prisma to find affected users</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Import specific email sending functions</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> mailOnDelete </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./mail/onDelete'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports and validMails fetching ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#d73a49>notifyOnDelete</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">deleted</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> ApiEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> actor</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> User</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 1. Determine the audience (who needs this email?)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> affected </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">view_AffectedByEvents</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>findMany</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        where</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            eventId</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> deleted</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        select</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            userId</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Get the IDs of users affected by the deleted event</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        distinct</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>'userId'</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Ensure unique user IDs</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Get map of user IDs to emails for relevant locales</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> validMails </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>notifiableUsers</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Function to fetch emails of users interested in notifications</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 2. Loop through relevant locales (de/fr in this case)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token constant" style=color:#36acaa>LOCALES</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>forEach</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">locale</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// 3. Filter affected user IDs to get their email addresses for this locale</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> recipientEmails </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> affected</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>map</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> validMails</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">locale</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>get</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">userId</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Get email for user ID, results in string | undefined</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>filter</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">email</span><span class="token punctuation" style=color:#393A34>)</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> email </span><span class="token keyword" style=color:#00009f>is</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>!</span><span class="token operator" style=color:#393A34>!</span><span class="token plain">email</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Filter out undefined values</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// 4. If there are recipients, call the specific mail sending function</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">recipientEmails</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">length </span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token function" style=color:#d73a49>mailOnDelete</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Calls the function that creates and sends the 'deleted' email</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 deleted</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> deleted</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Pass the deleted event</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 actor</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> actor</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// Pass the user who deleted it</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 to</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> recipientEmails</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// List of email addresses</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 locale</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> locale    </span><span class="token comment" style=color:#999988;font-style:italic>// Language for the email</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Note: This is async, but often not awaited here to avoid blocking.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// --- Simplified notifyOnUpdate example ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> notifyOnUpdate </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    events</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> event</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> ApiEvent</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> previous</span><span class="token operator" style=color:#393A34>?</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> ApiEvent</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* ... */</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    message</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* reason for refusal */</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    actor</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> User</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// ... complex logic here to find which users are newly affected, no longer affected, etc. ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// ... uses prisma.view_AffectedByEvents and other queries ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// Based on complex logic, build lists of recipients for different types of updates</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// For example, send specific emails for:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// - Event accepted (to author, possibly affected users) -> calls mailOnAccept</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// - Event refused (to author, admins) -> calls mailOnRefused</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// - Event updated (to affected users who were and still are affected) -> calls mailOnChange with type AFFECTED</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// - Event updated (to users newly affected) -> calls mailOnChange with type AFFECTED_NOW</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// - Event updated (to users no longer affected) -> calls mailOnChange with type AFFECTED_PREVIOUS</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// - Event sent for review (to admins) -> calls mailOnReviewRequest</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// mailOnAccept, mailOnRefused, mailOnChange, mailOnReviewRequest are imported from './mail/*.ts'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// await mailOnAccept(...)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// await mailOnRefused(...)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// await mailOnChange(...)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// await mailOnChange(...)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// await mailOnChange(...)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// await mailOnReviewRequest(...)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// All these functions internally call sendMail</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other notification logic (e.g., notifyOnAccept, notifyOnRefused, notifyOnReviewRequest)...</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>notifyOnDelete</code> and <code>notifyOnUpdate</code> and similar functions in <code>src/services/notifications/notifyUsers.ts</code> are the central points for deciding <em>who</em> gets an email and <em>what type</em> of email based on the event change and the user base.</li>
<li>They use <a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a> (e.g., <code>prisma.view_AffectedByEvents.findMany</code>) to query the database and find the relevant users.</li>
<li>They fetch the email addresses for these users, often filtering based on language/locale and the user's notification preferences (<code>notifyOnEventUpdate</code>, <code>notifyAdminOnReviewRequest</code>, etc.).</li>
<li>They then call specific email generation and sending functions (like <code>mailOnDelete</code>, <code>mailOnChange</code>, <code>mailOnAccept</code>, etc., imported from <code>src/services/notifications/mail/*.ts</code>), passing the event details, the actor, recipient list, and locale.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2-generating-and-sending-the-email-srcservicesnotificationsmailts-and-authconfigts>2. Generating and Sending the Email (<code>src\services\notifications\mail\*.ts</code> and <code>authConfig.ts</code>)<a href=#2-generating-and-sending-the-email-srcservicesnotificationsmailts-and-authconfigts class=hash-link aria-label="Direkter Link zur 2-generating-and-sending-the-email-srcservicesnotificationsmailts-and-authconfigts" title="Direkter Link zur 2-generating-and-sending-the-email-srcservicesnotificationsmailts-and-authconfigts">â€‹</a></h3>
<p>The functions in <code>src/services/notifications/mail/</code> (like <code>mailOnDelete.ts</code>, <code>onChange.ts</code>, <code>onAccepted.ts</code>, <code>onRefused.ts</code>, <code>onReviewRequest.ts</code>) are responsible for:</p>
<ul>
<li>Formatting the email content using libraries like <code>mailgen</code> to create structured HTML emails.</li>
<li>Defining the subject line, intro text, and tabular data summarizing the event details or changes.</li>
<li>Calling the low-level mail sending function (<code>sendMail</code>) with the complete email configuration (sender, recipients, subject, HTML/text body).</li>
</ul>
<p>The <code>sendMail</code> function in <code>src\services\notifications\mail\authConfig.ts</code> handles the actual interaction with an external SMTP server (the service that delivers emails) using Nodeemailer:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified snippet from src\services\notifications\mail\authConfig.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> createTransport </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'nodemailer'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Library for sending emails</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Mail </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'nodemailer/lib/mailer'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Nodemailer types</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> SMTPTransport </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'nodemailer/lib/smtp-transport'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// SMTP transport types</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Configuration for connecting to the email server (uses environment variables)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> authConfig</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Readonly</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">SMTPTransport</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">Options</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> Object</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>freeze</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    service</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'edubern365'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Example service name</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    host</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>MAIL_HOST</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>''</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Email server address</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ... other connection details and credentials securely stored in env vars ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    auth</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Object</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>freeze</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        user</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>MAIL_USERNAME</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>''</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        pass</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>MAIL_PASSWORD</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>''</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#d73a49>sendMail</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">config</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Mail</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">Options</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>NODE_ENV</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'test'</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* || !process.env.MAIL_HOST */</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// In test/dev without config, simulate success without sending</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Simulating email send:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> config</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">subject</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'to:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> config</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">to </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> config</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">bcc </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'N/A'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>resolve</span><span class="token punctuation" style=color:#393A34>(</span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 1. Create a Nodemailer transporter instance using the authConfig</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> transporter </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>createTransport</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">authConfig</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 2. Send the email using the configured transporter and the provided content config</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> transporter</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>sendMail</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>then</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">info</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// Log success information</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Email sent:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> info</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">response</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>catch</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// Log and handle errors during sending</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Error sending email:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>false</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li>The <code>authConfig</code> object holds the credentials and server details for connecting to the email sending service, loaded from environment variables for security.</li>
<li><code>createTransport(authConfig)</code> creates a "transporter" object, configured with the server details.</li>
<li><code>transporter.sendMail(config)</code> takes the email content configuration (sender, recipients, subject, body, etc.) and attempts to send the email through the external SMTP server.</li>
<li>The function handles promises to manage the asynchronous sending process and includes basic logging and error handling.</li>
</ol>
<p>The email-specific service functions (<code>mailOnDelete</code>, etc.) in <code>src/services/notifications/mail/</code> use <code>mailgen</code> to generate the HTML and plain text body and then call this <code>sendMail</code> function with the compiled content.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-complete-notification-flow>The Complete Notification Flow<a href=#the-complete-notification-flow class=hash-link aria-label="Direkter Link zur The Complete Notification Flow" title="Direkter Link zur The Complete Notification Flow">â€‹</a></h2>
<p>Let's visualize the end-to-end notification flow when an administrator deletes a published event.</p>
<!-- -->
<p>This diagram illustrates the dual path notifications take:</p>
<ul>
<li>The standard HTTP request triggers the change.</li>
<li>The Controller initiates <em>both</em> the Socket.IO notification (by setting <code>res.notifications</code>) and the Email notification (by directly calling an email service function).</li>
<li>The Socket.IO notification is picked up by a separate post-processor and sent via the persistent Socket.IO connections to connected clients.</li>
<li>The Email service function finds recipients by querying the DB and then sends the email through an external SMTP server.</li>
<li>Both notification types happen concurrently after the database change, ensuring prompt in-app updates and reliable external communication via email.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direkter Link zur Conclusion" title="Direkter Link zur Conclusion">â€‹</a></h2>
<p>The <code>events-api</code> provides a robust notification system by combining the speed of real-time Socket.IO messages with the reliability and detail of email. Controllers act as the trigger points, initiating both types of notifications immediately after a significant data change is successfully committed. Socket.IO updates are handled via the <code>res.notifications</code> property and a post-processing step, providing instant feedback to connected users. Email notifications are managed by calling dedicated service functions (like those in <code>src/services/notifications/notifyUsers.ts</code>) directly from the Controller; these services are responsible for identifying the correct email recipients and generating detailed email content using helper functions and an external mail sending transporter. This multi-channel approach ensures that users are effectively informed about changes that matter to them, supporting a responsive and reliable event management system.</p>
<hr>
<p>Generated by <a href=https://github.com/The-Pocket/Tutorial-Codebase-Knowledge target=_blank rel="noopener noreferrer">AI Codebase Knowledge Builder</a></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/lebalz/events-app/edit/main/10-dev/events-api/09_notifications__email___socket_io__.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Diese Seite bearbeiten</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Dokumentation Seiten"><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/dev/events-api/real_time_communication__socket_io__><div class=pagination-nav__sublabel>ZurÃ¼ck</div><div class=pagination-nav__label>real_time_communication__socket_io__</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/dev/guide-fr><div class=pagination-nav__sublabel>Weiter</div><div class=pagination-nav__label>Mode d'emploi FR</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#not-just-a-ticker-a-multi-channel-alert-system class="table-of-contents__link toc-highlight">Not Just a Ticker: A Multi-Channel Alert System</a><li><a href=#our-use-case-notifying-users-when-an-event-is-deleted class="table-of-contents__link toc-highlight">Our Use Case: Notifying Users When an Event is Deleted</a><li><a href=#triggering-notifications-from-the-controller class="table-of-contents__link toc-highlight">Triggering Notifications from the Controller</a><li><a href=#sending-socketio-notifications-recap class="table-of-contents__link toc-highlight">Sending Socket.IO Notifications (Recap)</a><li><a href=#sending-email-notifications class="table-of-contents__link toc-highlight">Sending Email Notifications</a><ul><li><a href=#1-identifying-recipients-and-content-logic-srcservicesnotificationsnotifyusersts class="table-of-contents__link toc-highlight">1. Identifying Recipients and Content Logic (<code>src\services\notifications\notifyUsers.ts</code>)</a><li><a href=#2-generating-and-sending-the-email-srcservicesnotificationsmailts-and-authconfigts class="table-of-contents__link toc-highlight">2. Generating and Sending the Email (<code>src\services\notifications\mail\*.ts</code> and <code>authConfig.ts</code>)</a></ul><li><a href=#the-complete-notification-flow class="table-of-contents__link toc-highlight">The Complete Notification Flow</a><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div><div id=popup-root></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Events</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/calendar>Kalender</a><li class=footer__item><a class=footer__link-item href=/table>Tabelle</a><li class=footer__item><a class=footer__link-item href=/gantt>Gantt</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Admin</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/admin>Dashboard</a><li class=footer__item><a class=footer__link-item href=/import>Import</a><li class=footer__item><a class=footer__link-item href=/docs>Dokumentation</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Links</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.gbsl.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBSL<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://gbjb.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBJB<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://github.com/lebalz/events-app target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://admin.socket.io/ target=_blank rel="noopener noreferrer" class=footer__link-item>Socket.IO Dashboard<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright Â© 2025 B. Hofer <br>
          <span class=translator-de>Ãœbersetzt von G. Andonie</span><br>
          <a class="badge badge--primary" href=https://github.com/lebalz/events-app/commit/6ac6c42c4cfe071ee1d4426440c2687f80d02166>
            áš¶ 6ac6c42
          </a>
          </div></div></div></footer></div>