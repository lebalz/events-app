<!doctype html><html lang=de-CH dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/events-api/real_time_communication__socket_io__" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>real_time_communication__socket_io__ | Events</title><meta data-rh=true property=og:image content=https://events.gbsl.website/img/og-preview.jpeg><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://events.gbsl.website/docs/dev/events-api/real_time_communication__socket_io__><meta data-rh=true property=og:locale content=de_CH><meta data-rh=true property=og:locale:alternate content=fr_CH><meta data-rh=true name=docusaurus_locale content=de><meta data-rh=true name=docsearch:language content=de><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="real_time_communication__socket_io__ | Events"><meta data-rh=true name=description content="Chapter 8: Real-time Communication (Socket.IO)"><meta data-rh=true property=og:description content="Chapter 8: Real-time Communication (Socket.IO)"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://events.gbsl.website/docs/dev/events-api/real_time_communication__socket_io__><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/real_time_communication__socket_io__ hreflang=de-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/fr/docs/dev/events-api/real_time_communication__socket_io__ hreflang=fr-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/real_time_communication__socket_io__ hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://events.gbsl.website/docs/dev/events-api/","name":"Tutorial: events-api","position":1},{"@type":"ListItem","item":"https://events.gbsl.website/docs/dev/events-api/real_time_communication__socket_io__","name":"real_time_communication__socket_io__","position":2}]}</script><link rel=icon href=/img/logo.png><link rel=manifest href=/manifest.json><meta name=theme-color content="rgb(0, 20, 117)"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/img/logo_x512.png><link rel=mask-icon href=/img/logo-light.svg color="rgb(0, 20, 117)"><meta name=msapplication-TileImage content=/img/logo_x512.png><meta name=msapplication-TileColor content=#000><script src="https://app.ruttl.com/plugin.js?id=zkNcmoSeOgS1ykIZJ5fl&e=1" id=ruttl-site-embed-script async defer></script><script src=https://umami.gbsl.website/tell-me.js data-website-id=575c1e8d-3c6d-45d9-a716-f7ad146761ab data-domains=events.gbsl.website async defer></script><link rel=stylesheet href=/assets/css/styles.c7ca49dc.css><script src=/assets/js/runtime~main.b6cccb6e.js defer></script><script src=/assets/js/main.c925edac.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/img/logo.svg><div data--isauthenticated=false></div><div role=region aria-label="Zum Hauptinhalt springen"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Zum Hauptinhalt springen</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Events</b></a><a class="navbar__item navbar__link" href=/calendar>Kalender</a><a class="navbar__item navbar__link" href=/table>Tabelle</a><a class="navbar__item navbar__link" href=/gantt>Zeitachse</a><a class="navbar__item navbar__link" href=/subscribe>Abonnieren</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs>?</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>Deutsch</a><ul class=dropdown__menu><li><a href=/docs/dev/events-api/real_time_communication__socket_io__ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=de-CH>Deutsch</a><li><a href=/fr/docs/dev/events-api/real_time_communication__socket_io__ target=_self rel="noopener noreferrer" class=dropdown__link lang=fr-CH>Français</a></ul></div><div class=""><span aria-describedby=popup-79><span style=display:inline-block aria-describedby=popup-80><button type=button class="button__qfG reducedPadding_vpuK iconRight_alf5 button button--outline button--primary"><span class=spacer_lB2W></span><span class=icon_Ceyd><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem role=presentation><path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" style=fill:currentColor /></svg></span><span class=spacer_lB2W></span></button></span></span></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="System Modus" aria-label="Umschalten zwischen dunkler und heller Ansicht (momentan System Modus)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Zurück nach oben scrollen" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs>Terminplan</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/login>Anmelden</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/events>Termine</a><button aria-label="Expand sidebar category 'Termine'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/betaphase>Einführungsphase</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true href=/docs/dev/intro>API Reference</a></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/intro>Events App</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/authentication>User Authentication</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/database>Database</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/dev/events-api>Tutorial: events-api</a><button aria-label="Collapse sidebar category 'Tutorial: events-api'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/database_orm__prisma__>Chapter 1: Database ORM (Prisma)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/data_logic__models__>Chapter 2: Data Logic (Models)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/api_web_server__express_js__>Chapter 3: API Web Server (Express.js)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/access_control__authentication___authorization__>Chapter 4: Access Control (Authentication & Authorization)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/request_handlers__controllers__>Chapter 5: Request Handlers (Controllers)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/external_data_sync_>Chapter 6: External Data Sync</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/background_task_runner__bree__>Chapter 7: Background Task Runner (Bree)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/dev/events-api/real_time_communication__socket_io__>real_time_communication__socket_io__</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/notifications__email___socket_io__>Chapter 9: Notifications (Email & Socket.IO)</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/guide-fr>Mode d'emploi FR</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/dev/scenes>Scenes</a><button aria-label="Expand sidebar category 'Scenes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/docs/dev/services/ics/images>Services</a></div></ul></ul></nav><button type=button title="Seitenleiste einklappen" aria-label="Seitenleiste einklappen" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>API Reference</span><li class=breadcrumbs__item><a class=breadcrumbs__link href=/docs/dev/events-api><span>Tutorial: events-api</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>real_time_communication__socket_io__</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">Auf dieser Seite</button></div><div class="theme-doc-markdown markdown"><header><h1>real_time_communication__socket_io__</h1></header><p>Chapter 8: Real-time Communication (Socket.IO)</p>
<p>Welcome back! We've covered a lot so far. You know how our <code>events-api</code> stores data (<a href=/docs/dev/events-api/database_orm__prisma__>Database ORM (Prisma)</a>), organizes data logic (<a href=/docs/dev/events-api/data_logic__models__>Data Logic (Models)</a>), receives requests (<a href=/docs/dev/events-api/api_web_server__express_js__>API Web Server (Express.js)</a>), secures them (<a href=/docs/dev/events-api/access_control__authentication___authorization__>Access Control (Authentication & Authorization)</a>), handles specific actions via Controllers (<a href=/docs/dev/events-api/request_handlers__controllers__>Request Handlers (Controllers)</a>), and even syncs data automatically from external sources or runs scheduled tasks in the background (<a href=/docs/dev/events-api/external_data_sync_>External Data Sync</a>, <a href=/docs/dev/events-api/background_task_runner__bree__>Background Task Runner (Bree)</a>).</p>
<p>All these processes involve the client (like a user's web browser) <em>asking</em> the server for information or to perform an action. The server <em>responds</em> to that request, and then the connection for that specific request is usually closed.</p>
<p>But what if something changes on the server <em>after</em> the client has finished asking questions? Imagine an administrator updates an event that several users are currently viewing, or a background job an administrator started finishes. How do the clients know about these changes without constantly asking the server "Is anything new yet? Is anything new yet?" (a process called "polling")?</p>
<p>This constant asking can be inefficient and slow. We need a way for the server to say: "Hey! Something you care about just changed! Here's the update!" and send it instantly to the relevant client(s).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-live-news-ticker>The Live News Ticker<a href=#the-live-news-ticker class=hash-link aria-label="Direkter Link zur The Live News Ticker" title="Direkter Link zur The Live News Ticker">​</a></h2>
<p>Imagine our application is like a news website. The standard API requests are like you refreshing the page to get the latest headlines.</p>
<p><strong>Real-time Communication</strong> is like having a <strong>live news ticker</strong> at the top of the page. The news source (the server) automatically <em>pushes</em> breaking news updates directly to your screen as soon as they happen, without you having to refresh the entire page.</p>
<p>This system allows the server to instantly send updates to users' browsers without them having to constantly ask for new information. When data changes (like an event is updated or a job finishes), the server can <em>push</em> that change directly to the clients who need to know.</p>
<p>In our <code>events-api</code>, this is used for:</p>
<ul>
<li>Notifying users when an event they are interested in is updated or deleted.</li>
<li>Informing users (especially administrators) when a background job (like an import or a sync) changes status or completes.</li>
<li>Potentially updating lists or specific UI elements in a connected frontend application without a full page reload.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=introducing-socketio-our-instant-messenger>Introducing Socket.IO: Our Instant Messenger<a href=#introducing-socketio-our-instant-messenger class=hash-link aria-label="Direkter Link zur Introducing Socket.IO: Our Instant Messenger" title="Direkter Link zur Introducing Socket.IO: Our Instant Messenger">​</a></h2>
<p>To build this live news ticker functionality, our <code>events-api</code> uses <strong>Socket.IO</strong>. Socket.IO is a library that enables real-time, bidirectional, event-based communication between the server (Node.js Express application) and the client (like a web browser).</p>
<p>Unlike standard HTTP requests which are short-lived (request-response-close), Socket.IO sets up a <strong>persistent connection</strong> between the client and the server. Think of this as keeping a dedicated phone line open between the two so they can talk back and forth instantly whenever needed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=key-concepts-of-socketio-simplified>Key Concepts of Socket.IO (Simplified)<a href=#key-concepts-of-socketio-simplified class=hash-link aria-label="Direkter Link zur Key Concepts of Socket.IO (Simplified)" title="Direkter Link zur Key Concepts of Socket.IO (Simplified)">​</a></h2>
<p>Socket.IO adds a layer on top of standard web protocols to provide this real-time capability. Here are the basic ideas:</p>
<ol>
<li><strong>Sockets:</strong> When a client successfully connects to the Socket.IO server, a "socket" object is created on both the client and the server. This socket represents the open, persistent connection. Each connected client has its own unique socket on the server side.</li>
<li><strong>Events:</strong> Instead of the HTTP request/response methods (<code>GET</code>, <code>POST</code>, etc.), communication over a socket happens by sending and receiving custom <strong>events</strong>. The server can <code>emit</code> an event (send a message) like <code>'event:updated'</code>, and the client can <code>on</code> this event (listen for it) to receive the message. The client can also <code>emit</code> events for the server to listen <code>on</code>. We define the types of events and the data they carry.</li>
<li><strong>Rooms:</strong> In a real application, you rarely want to send every single update to <em>every single connected client</em>. Socket.IO allows you to group sockets into <strong>rooms</strong>. A server can then <code>emit</code> a message specifically <code>to</code> a certain <code>room</code>. This is crucial for efficiently sending updates only to relevant users (e.g., only send admin-specific job status updates to admin-only sockets).</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=setting-up-socketio-in-events-api-srcserverts>Setting Up Socket.IO in <code>events-api</code> (<code>src\server.ts</code>)<a href=#setting-up-socketio-in-events-api-srcserverts class=hash-link aria-label="Direkter Link zur setting-up-socketio-in-events-api-srcserverts" title="Direkter Link zur setting-up-socketio-in-events-api-srcserverts">​</a></h2>
<p>The Socket.IO server needs to run alongside our existing Express HTTP server.</p>
<p>Look at the <code>src/server.ts</code> file. This is where our Express <code>app</code> is created and the standard Node.js HTTP server (<code>server</code>) is started, listening on a port. The Socket.IO server is attached to <em>this same HTTP server</em> instance.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\server.ts - Setting up Socket.IO</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> app </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./app'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Our Express application instance</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> http </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'http'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Logger </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./utils/logger'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Server </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'socket.io'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Import the Socket.IO Server class</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> passport </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'passport'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Need passport for authentication link</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Response</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> NextFunction </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Need Express types for middleware</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>PORT</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>PORT</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>3002</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> server </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> http</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>createServer</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">app</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Create the standard HTTP server using our Express app</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Create a new Socket.IO Server instance and attach it to the HTTP server</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> io </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>new</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style=color:#393A34>(</span><span class="token comment" style=color:#999988;font-style:italic>/* Pass the HTTP server */</span><span class="token plain"> server</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    cors</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        origin</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* ... настроить разрешенные домены CORS ... */</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        credentials</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        methods</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>'GET'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'POST'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'PUT'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'DELETE'</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Standard HTTP methods (though Socket.IO uses events)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ... other Socket.IO options ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// --- Integrate Socket.IO with Express/Passport Session/Auth ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Socket.IO connections don't use the same middleware pipeline as HTTP requests directly.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// We need to apply session and passport middleware to the Socket.IO connection handshake</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// so we can access `req.user` (the authenticated user) when a socket connects.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Use the same session middleware instance used by Express</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Needs conversion because Socket.IO and Express middleware types are slightly different</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 'socket.request' is the underlying HTTP request used for the initial handshake</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// We run express's sessionMiddleware on this request object</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>sessionMiddleware</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">request </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> Response</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> NextFunction</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// sessionMiddleware is imported from './app' (see actual file)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Apply passport initialize/session to the handshake request</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    passport</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>initialize</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">request </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> Response</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> NextFunction</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    passport</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>session</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">request </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> Response</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> NextFunction</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// --- Authentication Check for Socket Connections ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Only allow authenticated users to establish a Socket.IO connection</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Check if the user object was attached to the handshake request by passport</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">request </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If authenticated, allow the connection</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If not authenticated, disconnect the socket with an error</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'unauthorized'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... Routing logic for Socket.IO events (handled in EventRouter below) ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Make the Socket.IO instance accessible to Express request handlers (Controllers)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">app</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>use</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Request</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Attach the `io` instance to the Express request object (`req.io`)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">io </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> io</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... start the HTTP server normally ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">server</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>listen</span><span class="token punctuation" style=color:#393A34>(</span><span class="token constant" style=color:#36acaa>PORT</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>3002</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>application is running at: http://localhost:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation constant" style=color:#36acaa>PORT</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Press Ctrl+C to quit.'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>const server = http.createServer(app);</code>: The standard Node.js HTTP server is created using our Express <code>app</code>.</li>
<li><code>const io = new Server(server, { ... });</code>: A new Socket.IO server (<code>io</code> instance) is created and linked to the standard <code>server</code>. This makes Socket.IO listen on the same port and handle real-time connections alongside standard HTTP requests.</li>
<li><code>io.use((socket, next) => { ... })</code>: These lines apply our existing Express middleware for sessions and Passport authentication to the <em>handshake request</em> that initiates a Socket.IO connection. This is crucial because it allows Passport to identify the user associated with the socket connection and attach the <code>req.user</code> object, just like with regular HTTP requests.</li>
<li>The final <code>io.use</code> block checks if <code>req.user</code> exists after the authentication middleware. If not, it means the user isn't logged in, and the socket connection is rejected with an "unauthorized" error. This ensures only authenticated users can stay connected via Socket.IO.</li>
<li><code>app.use((req: Request, res, next) => { req.io = io; next(); });</code>: This middleware is added to the <em>Express application</em>. It takes the Socket.IO <code>io</code> instance and attaches it to <em>every</em> incoming Express <code>req</code> object as <code>req.io</code>. This makes the <code>io</code> instance readily available inside our Request Handlers (<a href=/docs/dev/events-api/request_handlers__controllers__>Request Handlers (Controllers)</a>), so they can easily trigger Socket.IO messages after processing an HTTP request. (The <code>src/types/express/index.d.ts</code> file adds the <code>io?</code> property to the Express <code>Request</code> interface).</li>
</ol>
<p>So, when a client connects, the Socket.IO server is initiated. It goes through the session/passport middleware, and if authenticated, the connection is established for that user. The <code>io</code> object, representing the connected Socket.IO server instance, is then cleverly attached to every subsequent <em>HTTP</em> request object (<code>req</code>) so that controllers can access it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=handling-socket-connections-and-rooms-srcroutessocketeventsts>Handling Socket Connections and Rooms (<code>src\routes\socketEvents.ts</code>)<a href=#handling-socket-connections-and-rooms-srcroutessocketeventsts class=hash-link aria-label="Direkter Link zur handling-socket-connections-and-rooms-srcroutessocketeventsts" title="Direkter Link zur handling-socket-connections-and-rooms-srcroutessocketeventsts">​</a></h2>
<p>When a new client successfully connects via Socket.IO, the server-side socket (<code>socket</code>) object is created, and the <code>io.on('connection', ...)</code> event handler in <code>src/routes/socketEvents.ts</code> is triggered. This is where we perform setup for the new connection, especially joining rooms.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\routes\socketEvents.ts - Handling Connections and Rooms</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>type</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> User </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'@prisma/client'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Server </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'socket.io'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoRoom </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./socketEvents'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Define our standard rooms</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#d73a49>EventRouter</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">io</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Server</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Accepts the Socket.IO server instance</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'connection'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// This runs whenever a new client connects</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Access the authenticated user from the handshake request (thanks to middleware in server.ts)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> user </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">request </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> user</span><span class="token operator" style=color:#393A34>?</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> User </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// We already check authentication via middleware, but this makes types clearer</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>!</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// Should not happen if middleware works, but good safeguard</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>disconnect</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Join Rooms for this socket ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Join the user's personal room (using their unique ID)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>join</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Enables sending messages specifically to THIS user</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Join the 'ALL' room (for messages sent to everyone)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>join</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">IoRoom</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ALL</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Enables sending messages to all connected users</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If the user is an ADMIN, join the 'ADMIN' room</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">role </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'ADMIN'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>join</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">IoRoom</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ADMIN</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Enables sending messages only to admins</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Accessing the Express session ID for other potential uses</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> sid </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">request </span><span class="token keyword" style=color:#00009f>as</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> sessionID</span><span class="token operator" style=color:#393A34>?</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">sessionID</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">sid</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             socket</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>join</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">sid</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Or use session ID if rooms per session are needed</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Define handlers for client-sent socket events (if any) ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Example: client requesting affected lessons for a hypothetical event</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// socket.on(IoEvents.AffectedLessons, async (eventId, semesterId, callback) => { ... });</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// ... more socket.on handlers ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ... handlers for disconnect, error, reconnect events ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>default</span><span class="token plain"> EventRouter</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Export the router function</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>io.on('connection', (socket) => { ... })</code>: This is the main event listener for successful new socket connections. The callback function receives the new <code>socket</code> object representing the client's connection.</li>
<li><code>const user = (socket.request as { user?: User }).user;</code>: We access the authenticated <code>user</code> object that was attached to the original HTTP handshake request object by the passport middleware (set up in <code>src/server.ts</code>).</li>
<li><code>socket.join(...)</code>: The core logic here involves calling <code>socket.join()</code> to add this specific socket to different rooms.<!-- -->
<ul>
<li><code>socket.join(user.id)</code>: The socket joins a room named after the user's unique ID. This allows sending messages specifically to this single user (<code>io.to(user.id).emit(...)</code>).</li>
<li><code>socket.join(IoRoom.ALL)</code>: Joins a universal room (<code>IoRoom.ALL</code> is just a constant defining the string 'all'). Sending to this room (<code>io.to(IoRoom.ALL).emit(...)</code>) sends the message to <em>all</em> connected clients.</li>
<li><code>socket.join(IoRoom.ADMIN)</code>: If the authenticated user's <code>role</code> is 'ADMIN', they also join an admin-specific room. Messages sent <code>io.to(IoRoom.ADMIN).emit(...)</code> only go to currently connected administrators.</li>
</ul>
</li>
<li>The <code>socket.on(...)</code> calls (commented out in the simplified example, but present in the full file) show how to listen for events <em>sent by the client</em> over the socket, allowing for bidirectional communication.</li>
</ol>
<p>This setup ensures that once a user is authenticated and connected via Socket.IO, their socket is placed into appropriate rooms, making it possible for the server to target notifications efficiently.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=how-controllers-trigger-notifications-resnotifications>How Controllers Trigger Notifications (<code>res.notifications</code>)<a href=#how-controllers-trigger-notifications-resnotifications class=hash-link aria-label="Direkter Link zur how-controllers-trigger-notifications-resnotifications" title="Direkter Link zur how-controllers-trigger-notifications-resnotifications">​</a></h2>
<p>Now that the Socket.IO server is running and connections are managed with rooms, how does a specific change in data, triggered by a standard HTTP request, initiate a real-time notification?</p>
<p>This happens in the Request Handlers (<a href=/docs/dev/events-api/request_handlers__controllers__>Request Handlers (Controllers)</a>). After a Controller successfully performs an action that changes data (like updating an event or completing a job), it adds information about the required notification(s) to a special property on the Express response object: <code>res.notifications</code>.</p>
<p>This <code>res.notifications</code> property is a custom addition to the Express <code>Response</code> type in our project (defined in <code>src/types/express/index.d.ts</code>). It's an array where Controllers can push notification objects.</p>
<p>Let's look at snippets from Controllers that do this:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified snippet from src\controllers\jobs.ts - update function</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> RequestHandler </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Notification </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/socketEventTypes'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Import types</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">Job</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Constant for the record type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token class-name keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> update</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> RequestHandler</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token comment" style=color:#999988;font-style:italic>/* ... */</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>try</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> model </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> Jobs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>updateModel</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token operator" style=color:#393A34>!</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">params</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">body</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Add notification details to res.notifications ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">notifications </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Start an array of notifications</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                message</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> type</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> record</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> model </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// What the message is about (type and the updated record)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                event</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>CHANGED_RECORD</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The type of Socket.IO event to emit</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                to</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Determine recipient room/ID based on job data */</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>getAudience</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Who should receive this notification?</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// ----------------------------------------------------</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>200</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>json</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Send the standard HTTP response</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>catch</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Simplified helper function to determine audience for a job notification</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> getAudience </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">job</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> userId</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> events</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* Simplified */</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// If the job affects published events or admin events, send to ADMIN room</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> job</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">events</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>some</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> e</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">state </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'PUBLISHED'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> e</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">state </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'REVIEW'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> e</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">state </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'REFUSED'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">       </span><span class="token operator" style=color:#393A34>?</span><span class="token plain"> IoRoom</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ADMIN</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Assume admins care about jobs affecting public/reviewed/refused events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token comment" style=color:#999988;font-style:italic>// Otherwise, send only to the user who started the job</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">       </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> job</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">userId</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Send to the user's specific room</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified snippet from src\controllers\events.ts - update function</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> RequestHandler </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Notification </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/socketEventTypes'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">Event</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> update</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> RequestHandler</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token comment" style=color:#999988;font-style:italic>/* ... */</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>try</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> model </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> Events</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>updateModel</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token operator" style=color:#393A34>!</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">params</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">body</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Logic to get related groups/users happens here...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Add notification details to res.notifications ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">notifications </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                message</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> type</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> record</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> model </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The updated event record</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                event</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>CHANGED_RECORD</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The type of Socket.IO event</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                to</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Determine recipients based on event state (draft vs published)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                    model</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">state </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'DRAFT'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                        </span><span class="token operator" style=color:#393A34>?</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token operator" style=color:#393A34>!</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token comment" style=color:#999988;font-style:italic>/* ... and group members */</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Only author/group members for drafts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                        </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoRoom</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ALL</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// All connected users for published events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// ----------------------------------------------------</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>200</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>json</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Send the standard HTTP response</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>catch</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic>// ... error handling ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified snippet from src\controllers\departments.ts - destroy function</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> RequestHandler </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'express'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Notification </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/socketEventTypes'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> IoRoom </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../routes/socketEvents'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Import IoRoom</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> RecordType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">Department</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> destroy</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> RequestHandler</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> res</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> next</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>try</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> model </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> Departments</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>destroy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token operator" style=color:#393A34>!</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">params</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Add notification details for deletion ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">notifications </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                message</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> type</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token constant" style=color:#36acaa>NAME</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// For deletion, usually just the deleted ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                event</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>DELETED_RECORD</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The deletion event type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token class-name">to</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoRoom</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>ALL</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Departments are general data, notify all</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --------------------------------------------</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        res</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>status</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>204</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>send</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Send the standard HTTP response (No Content for delete)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>catch</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>next</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li>After the Model operation (e.g., <code>Jobs.updateModel</code>, <code>Events.updateModel</code>, <code>Departments.destroy</code>) is successful, the Controller creates an array of <code>Notification</code> objects.</li>
<li>Each object in the <code>res.notifications</code> array describes <em>one</em> notification to be sent.</li>
<li><code>message</code>: Contains the payload for the Socket.IO message. It includes the <code>type</code> of record (<code>RecordType</code> enum like <code>'JOB'</code>, <code>'EVENT'</code>, <code>'DEPARTMENT'</code>) and either the full <code>record</code> object (for create/update) or just the <code>id</code> (for delete).</li>
<li><code>event</code>: Specifies the type of Socket.IO event to be emitted (<code>IoEvent</code> enum like <code>'NEW_RECORD'</code>, <code>'CHANGED_RECORD'</code>, <code>'DELETED_RECORD'</code>).</li>
<li><code>to</code>: Crucially, this specifies the target for the message. It can be a single user ID (string) or an <code>IoRoom</code> constant (<code>IoRoom.ALL</code>, <code>IoRoom.ADMIN</code>). This determines <em>which</em> sockets (and thus which connected clients) should receive the message. Controllers determine the appropriate recipient(s) based on the context (e.g., event state, job owner).</li>
<li>The standard HTTP response is still sent after setting <code>res.notifications</code>. Setting this property does <em>not</em> send the Socket.IO message yet.</li>
</ol>
<p>This pattern allows Controllers to declare <em>intent</em> to send notifications without directly interacting with the <code>io</code> instance or the complexities of Socket.IO.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=sending-the-socketio-messages-srcroutesnotifyts>Sending the Socket.IO Messages (<code>src\routes\notify.ts</code>)<a href=#sending-the-socketio-messages-srcroutesnotifyts class=hash-link aria-label="Direkter Link zur sending-the-socketio-messages-srcroutesnotifyts" title="Direkter Link zur sending-the-socketio-messages-srcroutesnotifyts">​</a></h2>
<p>Okay, Controllers add notifications to <code>res.notifications</code>. Who actually <em>reads</em> this property and sends the messages over Socket.IO?</p>
<p>This happens in a post-processing step <em>after</em> the Controller has finished but <em>before</em> the final HTTP response is fully sent back. The <code>events-api</code> uses a custom handler for this, likely implemented implicitly as part of the routing or error handling middleware flow, which checks <code>res.notifications</code> and uses a helper function to send the messages.</p>
<p>The <code>src/routes/notify.ts</code> file contains this helper function that interacts directly with the Socket.IO server instance (<code>io</code>).</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\routes\notify.ts - The helper to send messages</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>/* istanbul ignore file */</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// This file is ignored by code coverage because it depends on live Socket.IO</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Server </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'socket.io'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Import Socket.IO Server type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Import the types for our messages/events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> ChangedRecord</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Notification</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> RecordType </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./socketEventTypes'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Helper function to send a specific Socket.IO message</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#d73a49>notify</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">io</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Server </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>undefined</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> type</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> payload</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Object</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> to</span><span class="token operator" style=color:#393A34>?</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> IoRoom</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token operator" style=color:#393A34>!</span><span class="token plain">io</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Don't do anything if Socket.IO server instance is not available</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>return</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Handle single recipient or array of recipients</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> recipients </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>isArray</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">to</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>?</span><span class="token plain"> to </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">to </span><span class="token operator" style=color:#393A34>?</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain">to</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>undefined</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">recipients</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If specific recipients are defined, emit to each room/ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        recipients</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>forEach</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">roomOrId </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>to</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">roomOrId</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>emit</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">type</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> payload</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// If no recipient specified, emit to all connected sockets (less common in this app)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        io</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>emit</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">type</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> payload</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Specific helper for the common case of notifying about changed records</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> notifyChangedRecord </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    io</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Server </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>undefined</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The Socket.IO server instance (we get this from req.io)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    payload</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> ChangedRecord</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">RecordType</span><span class="token operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The message payload (type and record)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    to</span><span class="token operator" style=color:#393A34>?</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> IoRoom</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The recipient(s) (room or user ID)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Call the general notify function with the specific event type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token class-name">notify</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">io</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> IoEvent</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>CHANGED_RECORD</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> payload</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> to</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Similar helpers exist for NEW_RECORD and DELETED_RECORD events</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... notifyNewRecord, notifyDeletedRecord ...</span><br></span></code></pre></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>export const notify = (io: Server | undefined, ...)</code>: This function takes the Socket.IO <code>Server</code> instance (<code>io</code>), the <code>type</code> of event to emit (from <code>IoEvent</code>), the message <code>payload</code>, and the target <code>to</code> (a room name, user ID, or array of these).</li>
<li><code>io.to(roomOrId).emit(type, payload);</code>: <strong>This is where the message is actually sent!</strong>
<ul>
<li><code>io</code>: The Socket.IO server instance.</li>
<li><code>.to(roomOrId)</code>: Selects the specific room or individual socket (by ID) that should receive the message.</li>
<li><code>.emit(type, payload)</code>: Sends an event of the specified <code>type</code> (e.g., <code>'CHANGED_RECORD'</code>) with the given <code>payload</code> data to all sockets that are in the selected room(s).</li>
</ul>
</li>
<li><code>notifyChangedRecord(...)</code>: This function is a wrapper around <code>notify</code> specifically for the <code>'CHANGED_RECORD'</code> event type, making controller code cleaner.</li>
</ol>
<p>The post-processing step (not shown as a simple snippet, but implied by the structure of <code>src\routes\router.ts</code> and <code>$res.notifications</code> handler which you can find in the codebase) iterates through the <code>res.notifications</code> array <em>after</em> the controller finishes its <code>try</code> block, retrieves the <code>io</code> instance from <code>req.io</code>, and calls <code>notify</code> or <code>notifyChangedRecord</code> for each notification object in the array.</p>
<p>This decouples the notification <em>trigger</em> (in the Controller) from the notification <em>sending</em> (using the <code>notify</code> helper via the <code>io</code> instance).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=under-the-hood-the-real-time-flow>Under the Hood: The Real-time Flow<a href=#under-the-hood-the-real-time-flow class=hash-link aria-label="Direkter Link zur Under the Hood: The Real-time Flow" title="Direkter Link zur Under the Hood: The Real-time Flow">​</a></h2>
<p>Let's put it together and visualize the end-to-end flow when a user modifies an event (and assumes another user is connected via Socket.IO and viewing related data).</p>
<!-- -->
<p>This diagram shows that the standard HTTP request flow is used to <em>trigger</em> the data change. After the change is made and saved to the DB, the Controller adds the notification request (<code>res.notifications</code>). A separate part of the server then uses the <code>io</code> instance (made available on <code>req.io</code>) and the <code>notify</code> helper to send the real-time message over the persistent Socket.IO connections to any relevant clients.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direkter Link zur Conclusion" title="Direkter Link zur Conclusion">​</a></h2>
<p>Real-time communication using Socket.IO is a powerful feature that allows our <code>events-api</code> to actively push updates to connected clients whenever important data changes, like event details or job statuses. This avoids inefficient polling and provides a more dynamic and responsive user experience.</p>
<p>Socket.IO runs alongside the Express HTTP server, establishing persistent connections (sockets) with authenticated clients. These sockets are organized into rooms (<code>IoRoom.ALL</code>, <code>IoRoom.ADMIN</code>, user ID rooms) for targeted messaging. Controllers trigger notifications by adding details to the <code>res.notifications</code> property after data changes. A post-processing step reads this property and uses the Socket.IO server instance (<code>req.io</code>) and helper functions like <code>notifyChangedRecord</code> to <code>emit</code> the appropriate events to the relevant rooms, instantly updating connected users.</p>
<p>While Socket.IO handles the technical delivery of real-time messages, these messages are often part of a broader strategy for informing users about changes, which can also include other methods like email. We'll explore this combined notification system in the next chapter.</p>
<p><a href=/docs/dev/events-api/notifications__email___socket_io__>Next Chapter: Notifications (Email & Socket.IO)</a></p>
<hr>
<p>Generated by <a href=https://github.com/The-Pocket/Tutorial-Codebase-Knowledge target=_blank rel="noopener noreferrer">AI Codebase Knowledge Builder</a></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/lebalz/events-app/edit/main/10-dev/events-api/08_real_time_communication__socket_io__.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Diese Seite bearbeiten</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Dokumentation Seiten"><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/dev/events-api/background_task_runner__bree__><div class=pagination-nav__sublabel>Zurück</div><div class=pagination-nav__label>Chapter 7: Background Task Runner (Bree)</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/dev/events-api/notifications__email___socket_io__><div class=pagination-nav__sublabel>Weiter</div><div class=pagination-nav__label>Chapter 9: Notifications (Email & Socket.IO)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#the-live-news-ticker class="table-of-contents__link toc-highlight">The Live News Ticker</a><li><a href=#introducing-socketio-our-instant-messenger class="table-of-contents__link toc-highlight">Introducing Socket.IO: Our Instant Messenger</a><li><a href=#key-concepts-of-socketio-simplified class="table-of-contents__link toc-highlight">Key Concepts of Socket.IO (Simplified)</a><li><a href=#setting-up-socketio-in-events-api-srcserverts class="table-of-contents__link toc-highlight">Setting Up Socket.IO in <code>events-api</code> (<code>src\server.ts</code>)</a><li><a href=#handling-socket-connections-and-rooms-srcroutessocketeventsts class="table-of-contents__link toc-highlight">Handling Socket Connections and Rooms (<code>src\routes\socketEvents.ts</code>)</a><li><a href=#how-controllers-trigger-notifications-resnotifications class="table-of-contents__link toc-highlight">How Controllers Trigger Notifications (<code>res.notifications</code>)</a><li><a href=#sending-the-socketio-messages-srcroutesnotifyts class="table-of-contents__link toc-highlight">Sending the Socket.IO Messages (<code>src\routes\notify.ts</code>)</a><li><a href=#under-the-hood-the-real-time-flow class="table-of-contents__link toc-highlight">Under the Hood: The Real-time Flow</a><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div><div id=popup-root></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Events</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/calendar>Kalender</a><li class=footer__item><a class=footer__link-item href=/table>Tabelle</a><li class=footer__item><a class=footer__link-item href=/gantt>Gantt</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Admin</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/admin>Dashboard</a><li class=footer__item><a class=footer__link-item href=/import>Import</a><li class=footer__item><a class=footer__link-item href=/docs>Dokumentation</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Links</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.gbsl.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBSL<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://gbjb.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBJB<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://github.com/lebalz/events-app target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://admin.socket.io/ target=_blank rel="noopener noreferrer" class=footer__link-item>Socket.IO Dashboard<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025 B. Hofer <br>
          <span class=translator-de>Übersetzt von G. Andonie</span><br>
          <a class="badge badge--primary" href=https://github.com/lebalz/events-app/commit/482911ed97e7161c21c50e84b98b9528be079b6c>
            ᚶ 482911e
          </a>
          </div></div></div></footer></div>