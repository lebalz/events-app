<!doctype html><html lang=de-CH dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/events-api/background_task_runner__bree__" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Chapter 7: Background Task Runner (Bree) | Events</title><meta data-rh=true property=og:image content=https://events.gbsl.website/img/og-preview.jpeg><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://events.gbsl.website/docs/dev/events-api/background_task_runner__bree__><meta data-rh=true property=og:locale content=de_CH><meta data-rh=true property=og:locale:alternate content=fr_CH><meta data-rh=true name=docusaurus_locale content=de><meta data-rh=true name=docsearch:language content=de><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Chapter 7: Background Task Runner (Bree) | Events"><meta data-rh=true name=description content="Welcome back! In our last chapter, External Data Sync, we looked at how our events-api gets crucial data from outside sources like the Untis school system and legacy files through dedicated scripts, separate from the main web server request flow. These scripts handle tasks like fetching data periodically or importing large datasets."><meta data-rh=true property=og:description content="Welcome back! In our last chapter, External Data Sync, we looked at how our events-api gets crucial data from outside sources like the Untis school system and legacy files through dedicated scripts, separate from the main web server request flow. These scripts handle tasks like fetching data periodically or importing large datasets."><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://events.gbsl.website/docs/dev/events-api/background_task_runner__bree__><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/background_task_runner__bree__ hreflang=de-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/fr/docs/dev/events-api/background_task_runner__bree__ hreflang=fr-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/background_task_runner__bree__ hreflang=x-default><link rel=icon href=/img/logo.png><link rel=manifest href=/manifest.json><meta name=theme-color content="rgb(0, 20, 117)"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/img/logo_x512.png><link rel=mask-icon href=/img/logo-light.svg color="rgb(0, 20, 117)"><meta name=msapplication-TileImage content=/img/logo_x512.png><meta name=msapplication-TileColor content=#000><script src="https://app.ruttl.com/plugin.js?id=zkNcmoSeOgS1ykIZJ5fl&e=1" id=ruttl-site-embed-script async defer></script><script src=https://umami.gbsl.website/tell-me.js data-website-id=575c1e8d-3c6d-45d9-a716-f7ad146761ab data-domains=events.gbsl.website async defer></script><link rel=stylesheet href=/assets/css/styles.7fc65291.css><script src=/assets/js/runtime~main.f1e635f9.js defer></script><script src=/assets/js/main.a8fa469e.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id=__docusaurus><link rel=preload as=image href=/img/logo.svg><div data--isauthenticated=false></div><div role=region aria-label="Zum Hauptinhalt springen"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Zum Hauptinhalt springen</a></div><div class=announcementBar_mb4j style=background-color:var(--color-current-week-odd-background);color:var(--ifm-font-color-base) role=banner><div class=announcementBarPlaceholder_vyr4></div><div class="content_knG7 announcementBarContent_xLdY">EinfÃ¼hrungsphase: rc-1.6</div><button type=button aria-label=SchlieÃŸen class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width=14 height=14><g stroke=currentColor stroke-width=3.1><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"/></g></svg></button></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo.svg alt="Events App" class="logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Events</b></a><a class="navbar__item navbar__link" href=/calendar>Kalender</a><a class="navbar__item navbar__link" href=/table>Tabelle</a><a class="navbar__item navbar__link" href=/gantt>Zeitachse</a><a class="navbar__item navbar__link" href=/subscribe>Abonnieren</a></div><div class="navbar__items navbar__items--right"><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs>?</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>Deutsch</a><ul class=dropdown__menu><li><a href=/docs/dev/events-api/background_task_runner__bree__ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=de-CH>Deutsch</a><li><a href=/fr/docs/dev/events-api/background_task_runner__bree__ target=_self rel="noopener noreferrer" class=dropdown__link lang=fr-CH>FranÃ§ais</a></ul></div><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem;transform:scaleX(-1);transform-origin:center role=presentation><style>@keyframes spin-inverse{0%{transform:rotate(0)}to{transform:rotate(-360deg)}}</style><g style="animation:spin-inverse linear 2s infinite;transform-origin:center"><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z" style=fill:var(--ifm-color-primary) /></g></svg><div class=""><span aria-describedby=popup-59><span style=display:inline-block aria-describedby=popup-60><button type=button class="button__qfG reducedPadding_vpuK iconRight_alf5 button button--outline button--primary"><span class=spacer_lB2W></span><span class=icon_Ceyd><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem role=presentation><path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" style=fill:currentColor /></svg></span><span class=spacer_lB2W></span></button></span></span></div><div><a href=/login>Login ðŸ”‘</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Umschalten zwischen dunkler und heller Ansicht (momentan heller Modus)" aria-label="Umschalten zwischen dunkler und heller Ansicht (momentan heller Modus)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="ZurÃ¼ck nach oben scrollen" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs>Terminplan</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/login>Anmelden</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/events>Termine</a><button aria-label="Expand sidebar category 'Termine'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/betaphase>EinfÃ¼hrungsphase</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true href=/docs/dev/intro>API Reference</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/intro>Events App</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/authentication>User Authentication</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/database>Database</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/dev/events-api>Tutorial: events-api</a><button aria-label="Collapse sidebar category 'Tutorial: events-api'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/database_orm__prisma__>Chapter 1: Database ORM (Prisma)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/data_logic__models__>Chapter 2: Data Logic (Models)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/api_web_server__express_js__>Chapter 3: API Web Server (Express.js)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/access_control__authentication___authorization__>Chapter 4: Access Control (Authentication & Authorization)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/request_handlers__controllers__>Chapter 5: Request Handlers (Controllers)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/external_data_sync_>Chapter 6: External Data Sync</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/dev/events-api/background_task_runner__bree__>Chapter 7: Background Task Runner (Bree)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/real_time_communication__socket_io__>real_time_communication__socket_io__</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/events-api/notifications__email___socket_io__>Chapter 9: Notifications (Email & Socket.IO)</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/guide-fr>Mode d'emploi FR</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/dev/scenes>Scenes</a><button aria-label="Expand sidebar category 'Scenes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/docs/dev/services/ics/images>Services</a></div></ul></ul></nav><button type=button title="Seitenleiste einklappen" aria-label="Seitenleiste einklappen" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>API Reference</span><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/docs/dev/events-api><span itemprop=name>Tutorial: events-api</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Chapter 7: Background Task Runner (Bree)</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">Auf dieser Seite</button></div><div class="theme-doc-markdown markdown"><header><h1>Chapter 7: Background Task Runner (Bree)</h1></header>
<p>Welcome back! In our last chapter, <a href=/docs/dev/events-api/external_data_sync_>External Data Sync</a>, we looked at how our <code>events-api</code> gets crucial data from outside sources like the Untis school system and legacy files through dedicated scripts, separate from the main web server request flow. These scripts handle tasks like fetching data periodically or importing large datasets.</p>
<p>But how do we make sure these scripts run automatically at the right time (scheduled tasks) or run in the background without blocking anything else? For instance, syncing Untis data might need to happen every night, or generating hundreds of calendar files based on subscriptions could take a long time. We don't want these long-running or scheduled tasks to interfere with the main application's responsiveness when users make requests via the API.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-night-shift-crew>The Night Shift Crew<a href=#the-night-shift-crew class=hash-link aria-label="Direkter Link zur The Night Shift Crew" title="Direkter Link zur The Night Shift Crew">â€‹</a></h2>
<p>Imagine our API application is like a bustling factory during the day, handling individual customer orders (user requests) quickly. The activities we discussed in previous chapters (<a href=/docs/dev/events-api/api_web_server__express_js__>API Web Server (Express.js)</a>, <a href=/docs/dev/events-api/request_handlers__controllers__>Request Handlers (Controllers)</a>, <a href=/docs/dev/events-api/data_logic__models__>Data Logic (Models)</a>) are the day shift workers processing these orders immediately.</p>
<p>However, some tasks aren't tied to a specific incoming order, or they take too long to do while a customer waits. These tasks need a dedicated "night shift crew" that works in the background.</p>
<p>These background tasks include:</p>
<ul>
<li><strong>Scheduled Maintenance:</strong> Like tidying up the database or performing regular backups (though not explicitly in this project's scope, it's a common example).</li>
<li><strong>Periodic Reports/Generation:</strong> Creating reports or files that are needed regularly (like generating calendar files for subscriptions).</li>
<li><strong>Long-Running Processing:</strong> Tasks that handle a large amount of data or take significant computation time (like syncing data from an external system if it's complex or involves fetching many things).</li>
</ul>
<p>This is where a <strong>Background Task Runner</strong> comes in. It's like the supervisor who manages the night shift crew, telling them <em>what</em> to do (<em>the job</em>) and <em>when</em> to do it (<em>the schedule</em>), ensuring they work independently without interrupting the day shift.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=introducing-bree-our-night-shift-foreman>Introducing Bree: Our Night Shift Foreman<a href=#introducing-bree-our-night-shift-foreman class=hash-link aria-label="Direkter Link zur Introducing Bree: Our Night Shift Foreman" title="Direkter Link zur Introducing Bree: Our Night Shift Foreman">â€‹</a></h2>
<p>In the <code>events-api</code> project, we use <strong>Bree</strong> as our background task runner. Bree is designed to run scheduled jobs in separate worker processes or threads. This is important because Node.js applications are typically single-threaded. If a single request handler or script runs a very long task, it blocks <em>all</em> other requests and processing. By running jobs in separate workers, the main application thread remains free and responsive.</p>
<p>Think of Bree as the system that kicks off the night shift crew (the jobs) on their own separate machines so they don't take up space or resources on the main factory floor.</p>
<p>Bree allows us to:</p>
<ol>
<li><strong>Define Jobs:</strong> Write the specific tasks we want to run in separate script files.</li>
<li><strong>Schedule Jobs:</strong> Tell Bree <em>when</em> to run these jobs (e.g., "every night at 3 AM", "every 6 hours").</li>
<li><strong>Run Jobs Independently:</strong> Bree starts these job scripts in dedicated worker threads or processes, isolating them from the main application server.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=our-use-case-periodically-generating-calendar-files-sync-ics>Our Use Case: Periodically Generating Calendar Files (<code>sync-ics</code>)<a href=#our-use-case-periodically-generating-calendar-files-sync-ics class=hash-link aria-label="Direkter Link zur our-use-case-periodically-generating-calendar-files-sync-ics" title="Direkter Link zur our-use-case-periodically-generating-calendar-files-sync-ics">â€‹</a></h2>
<p>A key feature of the <code>events-api</code> is providing calendar subscriptions in ICS format. These <code>.ics</code> files allow users to subscribe to events in external calendar applications (like Google Calendar, Outlook, Apple Calendar). The content of these files needs to be generated based on the current data in our database.</p>
<p>Generating these files for potentially many users, classes, or departments can take time. Moreover, these files need to be updated periodically as events change or new data is synced from Untis. This task is perfect for a background job.</p>
<p>Our use case is: <strong>Generate updated ICS calendar files for users, classes, and departments on a regular schedule.</strong></p>
<p>In the <code>events-api</code>, the task for this is called <code>sync-ics</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=how-bree-manages-the-sync-ics-job>How Bree Manages the <code>sync-ics</code> Job<a href=#how-bree-manages-the-sync-ics-job class=hash-link aria-label="Direkter Link zur how-bree-manages-the-sync-ics-job" title="Direkter Link zur how-bree-manages-the-sync-ics-job">â€‹</a></h2>
<p>Let's see how Bree is configured to run the <code>sync-ics</code> job.</p>
<p>Bree's configuration is primarily done in <code>src/bree-runner.ts</code>, and the actual job scripts live in the <code>src/jobs</code> directory.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1-configuring-bree-and-defining-the-job-srcbree-runnerts>1. Configuring Bree and Defining the Job (<code>src\bree-runner.ts</code>)<a href=#1-configuring-bree-and-defining-the-job-srcbree-runnerts class=hash-link aria-label="Direkter Link zur 1-configuring-bree-and-defining-the-job-srcbree-runnerts" title="Direkter Link zur 1-configuring-bree-and-defining-the-job-srcbree-runnerts">â€‹</a></h3>
<p>This file initializes Bree and tells it which jobs to run and their schedules.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\bree-runner.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Logger </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./utils/logger'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// For logging</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Bree </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'bree'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The Bree library</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> path </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'path'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Node.js path module</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>NODE_ENV</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>===</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'production'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>BREE</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Create a new Bree instance</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> bree </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>new</span><span class="token plain"> </span><span class="token class-name">Bree</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        logger</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Use our custom logger</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        root</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> path</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>join</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">__dirname</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'jobs'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Tell Bree where to find job scripts (the 'jobs' directory)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        jobs</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// --- Define our 'sync-ics' job ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                name</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'sync-ics'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// The name of the job, corresponds to the file name in 'src/jobs' (sync-ics.ts)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                interval</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'every 6 hours'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// How often to run the job</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token comment" style=color:#999988;font-style:italic>// This option runs the job once 20 seconds after Bree starts (useful for initial run)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token comment" style=color:#999988;font-style:italic>// date: new Date(Date.now() + 20 * 1000)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// This helps Bree find the job file correctly depending on if running raw TS or compiled JS</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        defaultExtension</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>TS_NODE</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>?</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'ts'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'js'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Listen for Bree events (optional, for logging)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    bree</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'worker created'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree: worker created for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    bree</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'worker deleted'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree: worker deleted for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    bree</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'worker started'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree: worker started for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Custom log</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    bree</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'worker ended'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree: worker ended for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Custom log</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    bree</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'worker error'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> name</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree: worker error for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> error</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Custom log</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Start Bree! This checks the schedule and runs jobs when they are due.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    bree</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>start</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree started</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified log</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">env</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>NODE_ENV</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>!==</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'test'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// Log if Bree is not started in development mode</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Bree not started</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified log</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="In die Zwischenablage kopieren" title=Kopieren class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>new Bree(...)</code>: Creates an instance of the Bree job runner.</li>
<li><code>root: path.join(__dirname, 'jobs')</code>: This tells Bree to look for job definition files (like <code>sync-ics.ts</code>) inside the <code>src/jobs</code> directory.</li>
<li><code>jobs: [ { name: 'sync-ics', interval: 'every 6 hours' } ]</code>: This is the crucial part that defines the <code>sync-ics</code> job.<!-- -->
<ul>
<li><code>name: 'sync-ics'</code>: Bree will look for a file named <code>sync-ics.ts</code> (or <code>sync-ics.js</code> depending on the environment) in the <code>root</code> directory. This file contains the actual code for the job.</li>
<li><code>interval: 'every 6 hours'</code>: This tells Bree to schedule this job to run approximately every 6 hours. Bree supports various scheduling options (cron syntax, milliseconds, dates, etc.).</li>
</ul>
</li>
<li><code>bree.start()</code>: This command kicks off the Bree scheduler. Bree will now periodically check the schedule for all defined jobs and run them when it's time.</li>
</ol>
<p>This configuration ensures that the <code>sync-ics.ts</code> script will be automatically executed by Bree every six hours.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2-writing-the-job-script-srcjobssync-icsts>2. Writing the Job Script (<code>src\jobs\sync-ics.ts</code>)<a href=#2-writing-the-job-script-srcjobssync-icsts class=hash-link aria-label="Direkter Link zur 2-writing-the-job-script-srcjobssync-icsts" title="Direkter Link zur 2-writing-the-job-script-srcjobssync-icsts">â€‹</a></h3>
<p>This is the actual code that performs the task of generating ICS files. Bree runs this script in a separate worker thread/process.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\jobs\sync-ics.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// This script is executed by Bree in a separate worker</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// worker_threads allows communication with the parent process (Bree)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> parentPort </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'worker_threads'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> prisma </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../prisma'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Our Prisma Client</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Users </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../models/user'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Our Users Model</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Services that contain the logic for creating ICS files</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> createIcsForClasses</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> createIcsForDepartments </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../services/createIcs'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Logger </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../utils/logger'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Logger for the job</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// The job logic is inside an async immediately-invoked function expression (IIFE)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'sync-ics job started'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>try</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Task 1: Generate ICS for individual users ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> usersWithUntisId </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>findMany</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             where</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> untisId</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> not</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>null</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Only sync ICS for users linked to Untis</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Syncing ICS for </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">usersWithUntisId</span><span class="token template-string interpolation punctuation" style=color:#393A34>.</span><span class="token template-string interpolation">length</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string string" style=color:#e3116c> users...</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Loop through users and generate their ICS file</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// The actual code processes in batches for performance</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> user </span><span class="token keyword" style=color:#00009f>of</span><span class="token plain"> usersWithUntisId</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token keyword" style=color:#00009f>try</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token comment" style=color:#999988;font-style:italic>// Call a function from the Users Model to create the ICS file for the user</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> Users</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>createIcs</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>debug</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Created ics file for user </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style=color:#393A34>.</span><span class="token template-string interpolation">id</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>catch</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>warning</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Error creating ics for user </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style=color:#393A34>.</span><span class="token template-string interpolation">id</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string string" style=color:#e3116c>: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">err</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Finished syncing user ICS files.'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Task 2: Generate ICS for classes ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Call a service function to create ICS files for all classes</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>createIcsForClasses</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Finished syncing class ICS files.'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Task 3: Generate ICS for departments ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Call a service function to create ICS files for all departments</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>createIcsForDepartments</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Finished syncing department ICS files.'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Disconnect Prisma client when done in the worker</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>$disconnect</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Prisma disconnected'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Signal completion to Bree ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// This is important for Bree to know the job ran successfully</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">parentPort</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            parentPort</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>postMessage</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'done'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token comment" style=color:#999988;font-style:italic>// If running as a standalone script (not via Bree), exit manually</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>exit</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>catch</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'sync-ics job failed'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Ensure Prisma is disconnected even on error</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>$disconnect</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>catch</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">logError </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Prisma disconnect failed after error'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> logError</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// --- Signal error to Bree ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">parentPort</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            parentPort</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>postMessage</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'error'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            process</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>exit</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Execute the async function immediately</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="In die Zwischenablage kopieren" title=Kopieren class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>(async () => { ... })()</code>: The entire job logic is wrapped in an asynchronous immediately-invoked function. This allows using <code>await</code> directly at the top level of the script.</li>
<li><code>import prisma from '../prisma';</code>, <code>import Users from '../models/user';</code>, <code>import { createIcsForClasses, createIcsForDepartments } from '../services/createIcs';</code>: The job script imports the necessary components to perform its task â€“ our <a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a> client to interact with the database, our <a href=/docs/dev/events-api/data_logic__models__>Users Model</a> (which has the <code>createIcs</code> function), and specific service functions responsible for the ICS generation logic (defined in <code>src/services/createIcs.ts</code>).</li>
<li><code>await prisma.user.findMany(...)</code>: The job script uses <a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a> to find all users who need an ICS file generated (users linked via <code>untisId</code>).</li>
<li><code>await Users.createIcs(user, user.id);</code>: It iterates through the users and calls a function from the <a href=/docs/dev/events-api/data_logic__models__>Users Model</a> (<code>createIcs</code>) to handle the complex logic of fetching the user's relevant events and generating the ICS file. This function likely uses <a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a> internally to query events.</li>
<li><code>await createIcsForClasses()</code> and <code>await createIcsForDepartments()</code>: These calls delegate the tasks of generating ICS files for classes and departments to dedicated service functions. These functions also interact with the database (via <a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a>) to fetch relevant events.</li>
<li><code>await prisma.$disconnect()</code>: It's good practice for job scripts that use Prisma to explicitly disconnect the Prisma client when the job is finished, freeing up database connections.</li>
<li><code>parentPort.postMessage('done');</code>: If the script is running in a worker thread managed by Bree (<code>parentPort</code> will exist), this line sends a message back to Bree indicating that the job completed successfully. Bree uses this to monitor the job status.</li>
<li><code>catch (err) { ... parentPort.postMessage('error'); ... }</code>: Includes error handling. If any error occurs during the job execution, it's logged, Prisma is disconnected, and an 'error' message is sent back to Bree.</li>
</ol>
<p>This script embodies the background task: it performs database reads (<a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a>, <a href=/docs/dev/events-api/data_logic__models__>Models</a>), calls data processing logic (services), and is designed to run independently without waiting for or responding to an HTTP request.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=under-the-hood-bree-and-workers>Under the Hood: Bree and Workers<a href=#under-the-hood-bree-and-workers class=hash-link aria-label="Direkter Link zur Under the Hood: Bree and Workers" title="Direkter Link zur Under the Hood: Bree and Workers">â€‹</a></h2>
<p>Let's visualize how Bree runs a job like <code>sync-ics</code>.</p>
<!-- -->
<p>This diagram shows:</p>
<ol>
<li>Bree is initialized and started <em>by</em> the main application but then runs independently in the background.</li>
<li>When a job is due, Bree doesn't run it in the main application thread. Instead, it creates a <em>separate</em> worker.</li>
<li>The actual job script (<code>sync-ics.ts</code>) runs inside this dedicated worker.</li>
<li>The job script interacts with <a href=/docs/dev/events-api/database_orm__prisma__>Prisma</a> and the database directly from its worker process.</li>
<li>Critically, the main application thread (handling Express requests) is <em>not</em> blocked while the job script runs, even if the job takes a long time.</li>
<li>The worker communicates back to Bree when it's finished, allowing Bree to monitor and manage the jobs.</li>
</ol>
<p>This isolation prevents long-running tasks like generating many ICS files from making the API unresponsive for users trying to fetch data or perform other quick actions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direkter Link zur Conclusion" title="Direkter Link zur Conclusion">â€‹</a></h2>
<p>Using a background task runner like Bree is essential for handling tasks that need to run independently of user requests, either on a schedule or because they are long-running. In the <code>events-api</code>, Bree manages jobs like <code>sync-ics</code>, which periodically generates calendar files. Bree runs these jobs in separate worker processes or threads, ensuring that the main web server thread remains free to handle incoming API requests quickly and efficiently. By defining jobs in the <code>src/jobs</code> directory and configuring their schedules in <code>src/bree-runner.ts</code>, we offload heavy or time-sensitive tasks from the main application flow.</p>
<p>We've now covered how the API handles incoming requests and interacts with data, as well as how it performs background tasks. But what about times when the server needs to send information <em>to</em> a client <em>without</em> the client having explicitly asked for it just then? This leads us to real-time communication.</p>
<p><a href=/docs/dev/events-api/real_time_communication__socket_io__>Next Chapter: Real-time Communication (Socket.IO)</a></p>
<hr>
<p>Generated by <a href=https://github.com/The-Pocket/Tutorial-Codebase-Knowledge target=_blank rel="noopener noreferrer">AI Codebase Knowledge Builder</a></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/lebalz/events-app/edit/main/10-dev/events-api/07_background_task_runner__bree__.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Diese Seite bearbeiten</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Dokumentation Seiten"><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/dev/events-api/external_data_sync_><div class=pagination-nav__sublabel>ZurÃ¼ck</div><div class=pagination-nav__label>Chapter 6: External Data Sync</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/dev/events-api/real_time_communication__socket_io__><div class=pagination-nav__sublabel>Weiter</div><div class=pagination-nav__label>real_time_communication__socket_io__</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#the-night-shift-crew class="table-of-contents__link toc-highlight">The Night Shift Crew</a><li><a href=#introducing-bree-our-night-shift-foreman class="table-of-contents__link toc-highlight">Introducing Bree: Our Night Shift Foreman</a><li><a href=#our-use-case-periodically-generating-calendar-files-sync-ics class="table-of-contents__link toc-highlight">Our Use Case: Periodically Generating Calendar Files (<code>sync-ics</code>)</a><li><a href=#how-bree-manages-the-sync-ics-job class="table-of-contents__link toc-highlight">How Bree Manages the <code>sync-ics</code> Job</a><ul><li><a href=#1-configuring-bree-and-defining-the-job-srcbree-runnerts class="table-of-contents__link toc-highlight">1. Configuring Bree and Defining the Job (<code>src\bree-runner.ts</code>)</a><li><a href=#2-writing-the-job-script-srcjobssync-icsts class="table-of-contents__link toc-highlight">2. Writing the Job Script (<code>src\jobs\sync-ics.ts</code>)</a></ul><li><a href=#under-the-hood-bree-and-workers class="table-of-contents__link toc-highlight">Under the Hood: Bree and Workers</a><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div><div id=popup-root></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Events</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/calendar>Kalender</a><li class=footer__item><a class=footer__link-item href=/table>Tabelle</a><li class=footer__item><a class=footer__link-item href=/gantt>Gantt</a></ul></div><div class="col footer__col"><div class=footer__title>Admin</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/admin>Dashboard</a><li class=footer__item><a class=footer__link-item href=/import>Import</a><li class=footer__item><a class=footer__link-item href=/docs>Dokumentation</a></ul></div><div class="col footer__col"><div class=footer__title>Links</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.gbsl.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBSL<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://gbjb.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBJB<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/lebalz/events-app target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://admin.socket.io/ target=_blank rel="noopener noreferrer" class=footer__link-item>Socket.IO Dashboard<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright Â© 2025 B. Hofer <br>
          <span class=translator-de>Ãœbersetzt von G. Andonie</span><br>
          <a class="badge badge--primary" href=https://github.com/lebalz/events-app/commit/edf9452440f25c9b39b8f68a1708f2a89589ca2e>
            áš¶ edf9452
          </a>
          </div></div></div></footer></div>