<!doctype html><html lang=fr-CH dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/events-api/external_data_sync_" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Chapter 6: External Data Sync | Ev√®nements</title><meta data-rh=true property=og:image content=https://events.gbsl.website/img/og-preview.jpeg><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://events.gbsl.website/fr/docs/dev/events-api/external_data_sync_><meta data-rh=true property=og:locale content=fr_CH><meta data-rh=true property=og:locale:alternate content=de_CH><meta data-rh=true name=docusaurus_locale content=fr><meta data-rh=true name=docsearch:language content=fr><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Chapter 6: External Data Sync | Ev√®nements"><meta data-rh=true name=description content='Welcome back! So far, we&apos;ve explored how our events-api handles incoming requests from the "outside world" ‚Äì think of a user clicking a button in a web application. We saw how Express.js receives the request (API Web Server (Express.js)), middleware secures it (Access Control (Authentication & Authorization)), Controllers direct it (Request Handlers (Controllers)), and Models and Prisma interact with the database (Data Logic (Models), Database ORM (Prisma)). This is the core flow for user-initiated actions.'><meta data-rh=true property=og:description content='Welcome back! So far, we&apos;ve explored how our events-api handles incoming requests from the "outside world" ‚Äì think of a user clicking a button in a web application. We saw how Express.js receives the request (API Web Server (Express.js)), middleware secures it (Access Control (Authentication & Authorization)), Controllers direct it (Request Handlers (Controllers)), and Models and Prisma interact with the database (Data Logic (Models), Database ORM (Prisma)). This is the core flow for user-initiated actions.'><link data-rh=true rel=icon href=/fr/img/favicon.ico><link data-rh=true rel=canonical href=https://events.gbsl.website/fr/docs/dev/events-api/external_data_sync_><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/external_data_sync_ hreflang=de-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/fr/docs/dev/events-api/external_data_sync_ hreflang=fr-CH><link data-rh=true rel=alternate href=https://events.gbsl.website/docs/dev/events-api/external_data_sync_ hreflang=x-default><link rel=icon href=/fr/img/logo.png><link rel=manifest href=/fr/manifest.json><meta name=theme-color content="rgb(0, 20, 117)"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#000><link rel=apple-touch-icon href=/fr/img/logo_x512.png><link rel=mask-icon href=/fr/img/logo-light.svg color="rgb(0, 20, 117)"><meta name=msapplication-TileImage content=/fr/img/logo_x512.png><meta name=msapplication-TileColor content=#000><script src="https://app.ruttl.com/plugin.js?id=zkNcmoSeOgS1ykIZJ5fl&e=1" id=ruttl-site-embed-script async defer></script><script src=https://umami.gbsl.website/tell-me.js data-website-id=575c1e8d-3c6d-45d9-a716-f7ad146761ab data-domains=events.gbsl.website async defer></script><link rel=stylesheet href=/fr/assets/css/styles.7fc65291.css><script src=/fr/assets/js/runtime~main.657c1a20.js defer></script><script src=/fr/assets/js/main.88704905.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id=__docusaurus><link rel=preload as=image href=/fr/img/logo.svg><div data--isauthenticated=false></div><div role=region aria-label="Aller au contenu principal"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Aller au contenu principal</a></div><div class=announcementBar_mb4j style=background-color:var(--color-current-week-odd-background);color:var(--ifm-font-color-base) role=banner><div class=announcementBarPlaceholder_vyr4></div><div class="content_knG7 announcementBarContent_xLdY">Einf√ºhrungsphase: rc-1.6</div><button type=button aria-label=Fermer class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width=14 height=14><g stroke=currentColor stroke-width=3.1><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"/></g></svg></button></div><nav aria-label=Principale class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle barre de navigation" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/fr/><div class=navbar__logo><img src=/fr/img/logo.svg alt="Application √âv√®nements" class="logo themedComponent_mlkZ themedComponent--light_NVdE"><img src=/fr/img/logo.svg alt="Application √âv√®nements" class="logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">√âv√®nements</b></a><a class="navbar__item navbar__link" href=/fr/calendar>Calendrier</a><a class="navbar__item navbar__link" href=/fr/table>Liste</a><a class="navbar__item navbar__link" href=/fr/gantt>Axe du temps</a><a class="navbar__item navbar__link" href=/fr/subscribe>S'abonner</a></div><div class="navbar__items navbar__items--right"><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/fr/docs>?</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>Fran√ßais</a><ul class=dropdown__menu><li><a href=/docs/dev/events-api/external_data_sync_ target=_self rel="noopener noreferrer" class=dropdown__link lang=de-CH>Deutsch</a><li><a href=/fr/docs/dev/events-api/external_data_sync_ target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=fr-CH>Fran√ßais</a></ul></div><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem;transform:scaleX(-1);transform-origin:center role=presentation><style>@keyframes spin-inverse{0%{transform:rotate(0)}to{transform:rotate(-360deg)}}</style><g style="animation:spin-inverse linear 2s infinite;transform-origin:center"><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z" style=fill:var(--ifm-color-primary) /></g></svg><div class=""><span aria-describedby=popup-68><span style=display:inline-block aria-describedby=popup-69><button type=button class="button__qfG reducedPadding_vpuK iconRight_alf5 button button--outline button--primary"><span class=spacer_lB2W></span><span class=icon_Ceyd><svg viewBox="0 0 24 24" style=width:1.5rem;height:1.5rem role=presentation><path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" style=fill:currentColor /></svg></span><span class=spacer_lB2W></span></button></span></span></div><div><a href=/fr/login>Login üîë</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Basculer entre une vue sombre et une vue claire (actuellement mode lumineux)" aria-label="Basculer entre une vue sombre et une vue claire (actuellement mode lumineux)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Retour D√©filement vers le haut" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="barre lat√©rale des documents" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/fr/docs/login>Anmelden</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/fr/docs>√âv√®nements</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/fr/docs/events>Termine</a><button aria-label="√âtendre la barre lat√©rale de la cat√©gorie 'Termine'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/fr/docs/betaphase>Einf√ºhrungsphase</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true href=/fr/docs/dev/intro>API Reference</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/intro>Events App</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/authentication>User Authentication</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/database>Database</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/fr/docs/dev/events-api>Tutorial: events-api</a><button aria-label="R√©duire la barre lat√©rale de la cat√©gorie 'Tutorial: events-api'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/database_orm__prisma__>Chapter 1: Database ORM (Prisma)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/data_logic__models__>Chapter 2: Data Logic (Models)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/api_web_server__express_js__>Chapter 3: API Web Server (Express.js)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/access_control__authentication___authorization__>Chapter 4: Access Control (Authentication & Authorization)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/request_handlers__controllers__>Chapter 5: Request Handlers (Controllers)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/fr/docs/dev/events-api/external_data_sync_>Chapter 6: External Data Sync</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/background_task_runner__bree__>Chapter 7: Background Task Runner (Bree)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/real_time_communication__socket_io__>real_time_communication__socket_io__</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/events-api/notifications__email___socket_io__>Chapter 9: Notifications (Email & Socket.IO)</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/fr/docs/dev/guide-fr>Mode d'emploi FR</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/fr/docs/dev/scenes>Scenes</a><button aria-label="√âtendre la barre lat√©rale de la cat√©gorie 'Scenes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/fr/docs/dev/services/ics/images>Services</a></div></ul></ul></nav><button type=button title="Replier la barre lat√©rale" aria-label="Replier la barre lat√©rale" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Page d'accueil" class=breadcrumbs__link href=/fr/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><span class=breadcrumbs__link>API Reference</span><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/fr/docs/dev/events-api><span itemprop=name>Tutorial: events-api</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Chapter 6: External Data Sync</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">Sur cette page</button></div><div class="theme-doc-markdown markdown"><header><h1>Chapter 6: External Data Sync</h1></header>
<p>Welcome back! So far, we've explored how our <code>events-api</code> handles incoming requests from the "outside world" ‚Äì think of a user clicking a button in a web application. We saw how Express.js receives the request (<a href=/fr/docs/dev/events-api/api_web_server__express_js__>API Web Server (Express.js)</a>), middleware secures it (<a href=/fr/docs/dev/events-api/access_control__authentication___authorization__>Access Control (Authentication & Authorization)</a>), Controllers direct it (<a href=/fr/docs/dev/events-api/request_handlers__controllers__>Request Handlers (Controllers)</a>), and Models and Prisma interact with the database (<a href=/fr/docs/dev/events-api/data_logic__models__>Data Logic (Models)</a>, <a href=/fr/docs/dev/events-api/database_orm__prisma__>Database ORM (Prisma)</a>). This is the core flow for user-initiated actions.</p>
<p>But what about data that doesn't come from a user clicking a button? Our application needs to know about things like accurate class timetables, teacher lists, and potentially old event data stored in other systems. This information changes over time and needs to be updated in our database somehow. It would be impractical (and prone to errors) for a person to manually enter or update all this every time it changes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-automated-courier-service>The Automated Courier Service<a href=#the-automated-courier-service class=hash-link aria-label="Lien direct vers The Automated Courier Service" title="Lien direct vers The Automated Courier Service">‚Äã</a></h2>
<p>Imagine our application's database is a library's catalog. User requests are like librarians looking up specific books or adding new ones based on patron requests.</p>
<p>External Data Sync is like having an <strong>automated courier service</strong> that regularly visits other libraries (external systems like the Untis school system or old file archives), collects updated lists of books, new arrival lists, or corrections to existing entries, and brings them back to our library to update our catalog.</p>
<p>This process runs independently of individual user requests. Its main goals are:</p>
<ul>
<li><strong>Fetch Data:</strong> Retrieve information from outside sources.</li>
<li><strong>Process Data:</strong> Clean, format, and maybe transform the data to fit our database structure.</li>
<li><strong>Sync Database:</strong> Add new records, update existing ones, or mark old ones as inactive based on the external data, using tools like <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a>.</li>
</ul>
<p>In our <code>events-api</code> project, this external data comes mainly from:</p>
<ol>
<li><strong>Untis:</strong> A school administration system containing timetables, teachers, classes, etc. This data needs to be synced regularly.</li>
<li><strong>Legacy Import Files:</strong> Old CSV or Excel files containing historical event data that needs to be imported once (or occasionally updated if the source files change).</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=our-use-case-getting-untis-timetables-into-the-database>Our Use Case: Getting Untis Timetables into the Database<a href=#our-use-case-getting-untis-timetables-into-the-database class=hash-link aria-label="Lien direct vers Our Use Case: Getting Untis Timetables into the Database" title="Lien direct vers Our Use Case: Getting Untis Timetables into the Database">‚Äã</a></h2>
<p>Let's focus on syncing data from the Untis system. The <code>events-api</code> needs to show accurate information about classes, teachers, and which lessons are happening, especially because events might affect teaching periods. This data is managed in Untis.</p>
<p>So, our use case for External Data Sync is: <strong>Synchronize timetable, class, and teacher data from the Untis system into the <code>events-api</code> database.</strong></p>
<p>This needs to happen automatically, perhaps daily or weekly.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=how-external-data-sync-works-not-via-api-requests>How External Data Sync Works (Not via API Requests)<a href=#how-external-data-sync-works-not-via-api-requests class=hash-link aria-label="Lien direct vers How External Data Sync Works (Not via API Requests)" title="Lien direct vers How External Data Sync Works (Not via API Requests)">‚Äã</a></h2>
<p>Unlike the API flow we saw earlier, syncing external data typically happens through:</p>
<ul>
<li><strong>Standalone Scripts:</strong> Programs that can be run manually or automatically by a scheduler.</li>
<li><strong>Background Jobs:</strong> Tasks that run in the background without blocking the main web server. (We'll cover how these are managed in the next chapter, <a href=/fr/docs/dev/events-api/background_task_runner__bree__>Background Task Runner (Bree)</a>).</li>
</ul>
<p>These processes don't wait for an incoming HTTP request. Instead, they are triggered by a cron job, a manual command, or a background task runner.</p>
<p>Let's look at the scripts that initiate these sync operations. In the <code>events-api</code> project, you'll find scripts in the <code>bin</code> directory for this purpose.</p>
<p>Here's a simplified look at <code>bin/sync-untis-2-db.ts</code>, the script for syncing Untis data:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified bin\sync-untis-2-db.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> fetchUntis </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../src/services/fetchUntis'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Imports the function to fetch data from Untis</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> syncUntis2DB </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../src/services/syncUntis2DB'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Imports the function to process and update DB</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// This function runs when the script is executed</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#d73a49>main</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// ... code to get the date for syncing and find the semester ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> semesterId </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'some-semester-id'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Example</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Starting Untis sync for semester'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> semesterId</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 1. Fetch data from Untis</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> untisData </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>fetchUntis</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">semesterId</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Pass semester info</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// 2. Process fetched data and update the database</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>syncUntis2DB</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">semesterId</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> untisData</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Untis sync finished.'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Execute the main function</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>main</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>catch</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copier dans le presse-papiers" title=Copier class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>Explanation:</strong></p>
<ul>
<li>This is a simple Node.js script that can be run from the command line (e.g., <code>yarn untis:sync 2023-01-01</code>).</li>
<li>It imports two main functions: <code>fetchUntis</code> (responsible for communicating with the external Untis API) and <code>syncUntis2DB</code> (responsible for taking the fetched data and updating our database).</li>
<li>The <code>main</code> function orchestrates the process: first fetch, then sync to DB.</li>
</ul>
<p>There's also a similar script like <code>bin/users-csv-to-db.ts</code> for importing data from files:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified bin\users-csv-to-db.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> parse </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'csv-parse'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Library to read CSV</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> fs </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'fs'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain">             </span><span class="token comment" style=color:#999988;font-style:italic>// Node.js file system module</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// ... other imports ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> prisma </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../src/prisma'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Need Prisma to write to DB</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Function to read, parse, and process the file</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#d73a49>processFile</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">filePath</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Processing file:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> filePath</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> parser </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> fs</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>createReadStream</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">filePath</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>pipe</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token function" style=color:#d73a49>parse</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* ... csv options ... */</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Set up CSV parsing</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    parser</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>on</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'readable'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>function</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>let</span><span class="token plain"> record</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>while</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">record </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> parser</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>read</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>!==</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>null</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// 1. Process each record from the file</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Processing record:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> record</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> userData </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* ... map csv columns to user data ... */</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// 2. Use Prisma to insert/update the data in the database</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">user</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>upsert</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 where</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> userData</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 update</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> userData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                 create</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> userData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Upserted user:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> userData</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>finished</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">parser</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>log</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Finished processing file:'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> filePath</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Execute the function with file paths</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>processFile</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">__dirname</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string string" style=color:#e3116c>/excel/gbsl-users.csv</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>catch</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token builtin">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">err</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// processFile(`${__dirname}/excel/gbjb-users.csv`).catch((err) => console.error(err));</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copier dans le presse-papiers" title=Copier class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>Explanation:</strong></p>
<ul>
<li>This script uses libraries (<code>csv-parse</code>, <code>fs</code>) to read local CSV files.</li>
<li>It reads the file line by line (or record by record for CSV).</li>
<li>For each record, it processes the data and then uses <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a> (<code>prisma.user.upsert</code>) to update or insert the record into the database.</li>
</ul>
<p>These scripts illustrate that External Data Sync involves dedicated code paths that are separate from the API request handling flow.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=under-the-hood-the-sync-process>Under the Hood: The Sync Process<a href=#under-the-hood-the-sync-process class=hash-link aria-label="Lien direct vers Under the Hood: The Sync Process" title="Lien direct vers Under the Hood: The Sync Process">‚Äã</a></h2>
<p>Let's look closer at the Untis sync process (<code>fetchUntis</code> and <code>syncUntis2DB</code>). This is a two-step process: Fetching and then Syncing/Processing.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-1-fetching-data-srcservicesfetchuntists>Step 1: Fetching Data (<code>src\services\fetchUntis.ts</code>)<a href=#step-1-fetching-data-srcservicesfetchuntists class=hash-link aria-label="Lien direct vers step-1-fetching-data-srcservicesfetchuntists" title="Lien direct vers step-1-fetching-data-srcservicesfetchuntists">‚Äã</a></h3>
<p>This module is responsible for communicating with the Untis API (the "other library"). It uses an external library (<code>webuntis</code>) to connect, authenticate, and request specific data (school years, teachers, classes, timetables).</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\services\fetchUntis.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> WebUntisSecretAuth </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'webuntis'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Library for Untis API</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Logger </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../utils/logger'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// Configure the Untis connection (uses environment variables for credentials)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> untis </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>new</span><span class="token plain"> </span><span class="token class-name">WebUntisSecretAuth</span><span class="token punctuation" style=color:#393A34>(</span><span class="token comment" style=color:#999988;font-style:italic>/* ... connection details ... */</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>interface</span><span class="token plain"> </span><span class="token class-name">UntisData</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    schoolyear</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified type</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token class-name">subjects</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    teachers</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    classes</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    timetable</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> fetchUntis </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">semester</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style=color:#393A34>)</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">UntisData</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified type for semester</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Start fetching Untis Data'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>login</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Authenticate with Untis API</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Login successful'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// --- Fetch data from Untis ---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> schoolyear </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>getSchoolyears</span><span class="token punctuation" style=color:#393A34>(</span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Get school years</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> subjects </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>getSubjects</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain">         </span><span class="token comment" style=color:#999988;font-style:italic>// Get subjects</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> teachers </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>getTeachers</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain">         </span><span class="token comment" style=color:#999988;font-style:italic>// Get teachers</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> classes </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>getClasses</span><span class="token punctuation" style=color:#393A34>(</span><span class="token boolean" style=color:#36acaa>true</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> schoolyear</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Get classes</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Needs to fetch timetable for each class/subject - this is more complex</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> timetable </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>getTimetableForWeek</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">semester</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">untisSyncDate</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>/* ... params ...*/</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Get timetable</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Finished fetching data'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> untis</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>logout</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Log out from Untis API</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> schoolyear</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> subjects</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> teachers</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> classes</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> timetable </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Return fetched data</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copier dans le presse-papiers" title=Copier class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>Explanation:</strong></p>
<ul>
<li>It initializes a connection object (<code>untis</code>) provided by the <code>webuntis</code> library, using configuration details (like school name, username, secret, base URL) typically stored in environment variables for security.</li>
<li>The <code>fetchUntis</code> function performs a series of <code>await untis....()</code> calls to retrieve different types of data from the Untis API.</li>
<li>It handles login and logout.</li>
<li>It returns a structured object containing all the fetched data (<code>UntisData</code>).</li>
</ul>
<p>This <code>fetchUntis</code> function is focused purely on <em>getting</em> the data from the external source. It doesn't modify our database.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-2-syncing-data-to-db-srcservicessyncuntis2dbts>Step 2: Syncing Data to DB (<code>src\services\syncUntis2DB.ts</code>)<a href=#step-2-syncing-data-to-db-srcservicessyncuntis2dbts class=hash-link aria-label="Lien direct vers step-2-syncing-data-to-db-srcservicessyncuntis2dbts" title="Lien direct vers step-2-syncing-data-to-db-srcservicessyncuntis2dbts">‚Äã</a></h3>
<p>This module takes the data fetched by <code>fetchUntis</code>, processes it, and updates our application's database using <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a>. This is where the "merge" happens.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>// Simplified src\services\syncUntis2DB.ts</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>type</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> Prisma</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> Semester </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'@prisma/client'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Prisma types</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> prisma </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../prisma'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Our Prisma Client instance</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> UntisData </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'./fetchUntis'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Data structure from fetchUntis</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>import</span><span class="token plain"> Logger </span><span class="token keyword" style=color:#00009f>from</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'../utils/logger'</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>export</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> syncUntis2DB </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>async</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    semesterId</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    data</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> UntisData </span><span class="token comment" style=color:#999988;font-style:italic>// The data received from fetchUntis</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Start syncing Untis Data to DB'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> dbTransactions</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> Prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">PrismaPromise</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token builtin">any</span><span class="token operator" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Collect database operations</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Example: Syncing Untis Classes</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    data</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">classes</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>forEach</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">untisClass</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Logic to map Untis class data to our database structure, find departments, etc.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> processedClassData </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisClass</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            name</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisClass</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Or a cleaned/mapped version</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// ... other relevant fields ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            year</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>2023</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified - actual logic in code</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            department</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> connect</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'some-dep-id'</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Simplified</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Use Prisma's upsert to update if the class exists or create if it doesn't</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> upsertClass </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">untisClass</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>upsert</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            where</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedClassData</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Match based on Untis ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            update</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedClassData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Data to update if found</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            create</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedClassData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Data to create if not found</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        dbTransactions</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">upsertClass</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Add the operation to the transaction list</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Example: Syncing Untis Teachers</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    data</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">teachers</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>forEach</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">untisTeacher</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> processedTeacherData </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisTeacher</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             name</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisTeacher</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             longName</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisTeacher</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">longName</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token comment" style=color:#999988;font-style:italic>// ... other fields ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             active</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisTeacher</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">active</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> upsertTeacher </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">untisTeacher</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>upsert</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             where</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedTeacherData</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             update</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedTeacherData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             create</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedTeacherData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         dbTransactions</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">upsertTeacher</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Example: Syncing Untis Timetable Lessons</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">     </span><span class="token comment" style=color:#999988;font-style:italic>// Note: Existing lessons for the semester might be deleted first</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    data</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">timetable</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>forEach</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">untisLesson</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token comment" style=color:#999988;font-style:italic>// Logic to map Untis lesson data, find related classes/teachers, etc.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> processedLessonData </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            room</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">rooms</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>map</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">r </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> r</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">element</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">name</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>join</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>', '</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            subject</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">subjects</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token operator" style=color:#393A34>?.</span><span class="token plain">name </span><span class="token operator" style=color:#393A34>||</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'Unknown'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            startTime</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">startTime</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            endTime</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">endTime</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token comment" style=color:#999988;font-style:italic>// ... other fields like date, weekday ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             semester</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> connect</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> semesterId </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token comment" style=color:#999988;font-style:italic>// Connect related classes and teachers using their IDs</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             classes</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> connect</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">classes</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>map</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">c </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> c</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// untis id -> our class id mapping happens here too</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             teachers</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> connect</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">teachers</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>map</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">t </span><span class="token operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> t</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> upsertLesson </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">untisLesson</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>upsert</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Usually lessons might entirely change, so delete+create or careful update logic might be needed.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             where</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> id</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedLessonData</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">id </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Assuming Untis IDs are stable</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             update</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedLessonData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             create</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> processedLessonData</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">         dbTransactions</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>push</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">upsertLesson</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Execute all collected database operations as a single transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Executing </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">dbTransactions</span><span class="token template-string interpolation punctuation" style=color:#393A34>.</span><span class="token template-string interpolation">length</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string string" style=color:#e3116c> database transactions...</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>await</span><span class="token plain"> prisma</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>$transaction</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">dbTransactions</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    Logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'Untis sync to DB finished.'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>// Returns a summary or success indicator</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copier dans le presse-papiers" title=Copier class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>Explanation:</strong></p>
<ul>
<li><code>syncUntis2DB</code> receives the fetched <code>UntisData</code>.</li>
<li>It iterates through the lists of classes, teachers, timetable entries, etc., contained within the <code>data</code> object.</li>
<li>For each external data piece, it performs necessary <strong>processing</strong> (like mapping or cleaning names). This is where logic similar to what you might find in a <a href=/fr/docs/dev/events-api/data_logic__models__>Model</a> lives, but adapted for bulk import/sync. Example: Mapping legacy class names using <code>mapLegacyClassName</code> (visible in the full snippet from <code>src\services\importEvents.ts</code>) or finding the correct <code>Department</code> based on class letters (<code>src\services\syncUntis2DB.ts</code>).</li>
<li>It uses <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a> methods like <code>upsert</code> (<code>update</code> or <code>insert</code>) or potentially <code>createMany</code>, <code>deleteMany</code>, etc., to apply the changes to the database.</li>
<li>Crucially, it collects all these individual database operations into an array (<code>dbTransactions</code>) and then executes them together using <code>await prisma.$transaction(dbTransactions)</code>. This ensures that either <em>all</em> the updates succeed, or if any part fails, <em>none</em> of the changes are applied, keeping the database in a consistent state (a transaction).</li>
<li>Connecting related data (like linking a lesson to its classes and teachers) is also handled here using Prisma's <code>connect</code> syntax.</li>
</ul>
<p>The logic for importing from CSV/Excel files (<code>src\services\importGBSL_xlsx.ts</code>, <code>src\services\importGBJB_csv.ts</code>, <code>src\services\importV1.ts</code>, <code>src\services\importEvents.ts</code>) follows a similar pattern: read file -> parse rows -> process data -> use <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a> (<code>create</code> or <code>upsert</code>) to write to DB. The processing steps for files involve logic like extracting classes from raw text (<code>extractClasses</code> in <code>src\services\importEvents.ts</code>) or mapping legacy department names (<code>mapLegacyClassName</code>, <code>fromDisplayClassName</code>).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=the-flow-of-external-data-sync>The Flow of External Data Sync<a href=#the-flow-of-external-data-sync class=hash-link aria-label="Lien direct vers The Flow of External Data Sync" title="Lien direct vers The Flow of External Data Sync">‚Äã</a></h2>
<p>Let's visualize the conceptual flow, showing that it's initiated differently from an API request.</p>
<!-- -->
<p>This diagram shows that the trigger starts the process, which directly interacts with the external source and then uses the Data Processor layer (our service functions like <code>fetchUntis</code> and <code>syncUntis2DB</code>) to handle the data transfer and synchronization with the database via <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a>. The middleware/router/controller layers from the API flow are not involved here.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Lien direct vers Conclusion" title="Lien direct vers Conclusion">‚Äã</a></h2>
<p>External Data Sync is a critical part of the <code>events-api</code>, responsible for keeping our database updated with information from sources outside the application, like the Untis school system and legacy files. This happens through dedicated scripts and background processes that are separate from handling user-initiated API requests.</p>
<p>This process involves fetching data from the external source (e.g., using <code>fetchUntis</code> and external libraries or file system modules), processing and cleansing that data, and then using <a href=/fr/docs/dev/events-api/database_orm__prisma__>Prisma</a> with functions like <code>upsert</code> (often within a transaction) to synchronize the information into our database. These tasks are often scheduled to run automatically, which brings us to the next chapter: how we manage and run these tasks reliably in the background.</p>
<p><a href=/fr/docs/dev/events-api/background_task_runner__bree__>Next Chapter: Background Task Runner (Bree)</a></p>
<hr>
<p>Generated by <a href=https://github.com/The-Pocket/Tutorial-Codebase-Knowledge target=_blank rel="noopener noreferrer">AI Codebase Knowledge Builder</a></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/lebalz/events-app/edit/main/i18n/fr/docusaurus-plugin-content-docs/current/10-dev/events-api/06_external_data_sync_.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Modifier cette page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Documentation Pages Navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/fr/docs/dev/events-api/request_handlers__controllers__><div class=pagination-nav__sublabel>Retour</div><div class=pagination-nav__label>Chapter 5: Request Handlers (Controllers)</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/fr/docs/dev/events-api/background_task_runner__bree__><div class=pagination-nav__sublabel>Continuer</div><div class=pagination-nav__label>Chapter 7: Background Task Runner (Bree)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#the-automated-courier-service class="table-of-contents__link toc-highlight">The Automated Courier Service</a><li><a href=#our-use-case-getting-untis-timetables-into-the-database class="table-of-contents__link toc-highlight">Our Use Case: Getting Untis Timetables into the Database</a><li><a href=#how-external-data-sync-works-not-via-api-requests class="table-of-contents__link toc-highlight">How External Data Sync Works (Not via API Requests)</a><li><a href=#under-the-hood-the-sync-process class="table-of-contents__link toc-highlight">Under the Hood: The Sync Process</a><ul><li><a href=#step-1-fetching-data-srcservicesfetchuntists class="table-of-contents__link toc-highlight">Step 1: Fetching Data (<code>src\services\fetchUntis.ts</code>)</a><li><a href=#step-2-syncing-data-to-db-srcservicessyncuntis2dbts class="table-of-contents__link toc-highlight">Step 2: Syncing Data to DB (<code>src\services\syncUntis2DB.ts</code>)</a></ul><li><a href=#the-flow-of-external-data-sync class="table-of-contents__link toc-highlight">The Flow of External Data Sync</a><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div><div id=popup-root></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>√âv√®nements</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/fr/calendar>Calendrier</a><li class=footer__item><a class=footer__link-item href=/fr/table>Liste</a><li class=footer__item><a class=footer__link-item href=/fr/gantt>Lignes de temps</a></ul></div><div class="col footer__col"><div class=footer__title>Administration</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/fr/admin>Dashboard</a><li class=footer__item><a class=footer__link-item href=/fr/import>Importation</a><li class=footer__item><a class=footer__link-item href=/fr/docs>Documentation</a></ul></div><div class="col footer__col"><div class=footer__title>Liens</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.gbsl.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBSL<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://gbjb.ch target=_blank rel="noopener noreferrer" class=footer__link-item>GBJB<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/lebalz/events-app target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://admin.socket.io/ target=_blank rel="noopener noreferrer" class=footer__link-item>Socket.IO > Tableau de bord<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright ¬© 2025 B. Hofer <br>
          <span class=translator-fr>Traduit par G. Andonie</span><br>
          <a class="badge badge--primary" href=https://github.com/lebalz/events-app/commit/29efac9c3af17f6aa235faf3ebb94cf003f11d94>
            ·ö∂ 29efac9
          </a>
          </div></div></div></footer></div>